<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <title>TrueReturn - Property Investment Calculator</title>
  <style>
    :root {
      /* Raw palette — primary (green) */
      --color-primary-50: #ECFDF5;
      --color-primary-100: #D1FAE5;
      --color-primary-200: #A7F3D0;
      --color-primary-300: #6EE7B7;
      --color-primary-400: #34D399;
      --color-primary-500: #10B981;
      --color-primary-600: #059669;
      --color-primary-700: #047857;
      --color-primary-800: #065F46;
      --color-primary-900: #064E3B;

      /* Raw palette — secondary (blue) */
      --color-secondary-50: #EFF6FF;
      --color-secondary-100: #DBEAFE;
      --color-secondary-200: #BFDBFE;
      --color-secondary-300: #93C5FD;
      --color-secondary-400: #60A5FA;
      --color-secondary-500: #3B82F6;
      --color-secondary-600: #2563EB;
      --color-secondary-700: #1D4ED8;
      --color-secondary-800: #1E40AF;
      --color-secondary-900: #1E3A8A;

      /* Semantic */
      --color-success: #10B981;
      --color-error: #EF4444;
      --color-warning: #F59E0B;
      --color-info: #3B82F6;

      /* Surface */
      --bg-body: #0B0F19;
      --bg-surface: #111827;
      --bg-elevated: #1F2937;
      --bg-input: #0B0F19;

      /* Text */
      --text-primary: #F9FAFB;
      --text-secondary: #9CA3AF;
      --text-muted: #6B7280;

      /* Borders */
      --border-default: #1F2937;
      --border-subtle: #374151;
      --border-strong: #4B5563;

      /* Component */
      --accent: #10B981;
      --accent-hover: #059669;
      --accent-bg: rgba(16, 185, 129, 0.08);
      --accent-bg-hover: rgba(16, 185, 129, 0.12);
      --focus-ring: rgba(16, 185, 129, 0.25);
      --positive: #10B981;
      --negative: #EF4444;
      --negative-bg: rgba(239, 68, 68, 0.06);
      --secondary-bg: rgba(59, 130, 246, 0.06);

      /* Effects */
      --card-gradient: linear-gradient(145deg, #1F2937, #111827);
      --card-glow: radial-gradient(circle at top, rgba(255,255,255,0.08), transparent);
      --shadow-color: rgba(0,0,0,0.5);

      /* Section borders */
      --section-border-primary: #065F46;
      --section-border-secondary: #1E40AF;
      --section-border-error: #991B1B;
      --section-border-warning: #92400E;

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-base: 200ms ease;

      /* Radius */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    [data-theme="light"] {
      --bg-body: #F3F4F6;
      --bg-surface: #FFFFFF;
      --bg-elevated: #F9FAFB;
      --bg-input: #FFFFFF;
      --text-primary: #1F2937;
      --text-secondary: #4B5563;
      --text-muted: #6B7280;
      --border-default: #E5E7EB;
      --border-subtle: #D1D5DB;
      --border-strong: #9CA3AF;
      --shadow-color: rgba(0,0,0,0.08);
      --card-gradient: linear-gradient(145deg, #FFFFFF, #F9FAFB);
      --card-glow: radial-gradient(circle at top, rgba(0,0,0,0.02), transparent);
      --section-border-primary: #A7F3D0;
      --section-border-secondary: #BFDBFE;
      --section-border-error: #FECACA;
      --section-border-warning: #FDE68A;
      --negative-bg: rgba(239, 68, 68, 0.05);
      --secondary-bg: rgba(59, 130, 246, 0.05);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', 'Söhne', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-body);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
      font-size: 0.9375rem;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    header {
      background: var(--bg-surface);
      color: var(--text-primary);
      padding: 1.25rem 2rem;
      border-bottom: 1px solid var(--border-default);
      box-shadow: 0 1px 2px var(--shadow-color);
      position: relative;
      z-index: 10;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 {
      font-size: 1.375rem;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: var(--accent);
      display: flex;
      align-items: center;
    }

    header p {
      color: var(--text-muted);
      font-size: 0.8125rem;
      margin-top: 0.125rem;
      letter-spacing: 0.01em;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
      background: var(--bg-elevated);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .theme-toggle:hover {
      color: var(--accent);
      border-color: var(--accent);
      background: var(--accent-bg);
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    .theme-toggle svg {
      width: 18px;
      height: 18px;
    }

    .theme-icon-moon { display: none; }
    .theme-icon-sun { display: block; }
    [data-theme="light"] .theme-icon-moon { display: block; }
    [data-theme="light"] .theme-icon-sun { display: none; }

    /* Layout: sidebar + content */
    .sidebar {
      background: var(--bg-surface);
      display: flex;
    }

    .sidebar-tab {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      padding: 0.875rem 1.25rem;
      background: none;
      border: none;
      border-left: 3px solid transparent;
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.8125rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: all var(--transition-base);
      text-align: left;
    }

    .sidebar-tab:hover {
      color: var(--text-primary);
      background: var(--accent-bg);
    }

    .sidebar-tab.active {
      color: var(--accent);
      border-left-color: var(--accent);
      background: var(--accent-bg-hover);
    }

    .sidebar-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sidebar-icon svg {
      width: 20px;
      height: 20px;
      fill: none;
      stroke: currentColor;
      stroke-width: 1.75;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .sidebar-shared-value {
      margin-top: 1rem;
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--border-default);
    }

    .sidebar-shared-value .shared-label {
      font-size: 0.625rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 0.375rem;
      display: block;
    }

    .sidebar-input {
      background: var(--bg-input);
    }

    .sidebar-input input {
      font-size: 0.9375rem;
      padding: 0.5rem 0.625rem;
      color: var(--accent);
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .content-area {
      flex: 1;
      max-width: 1280px;
      margin: 1.5rem auto;
      padding: 0 1.75rem;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active.tab-placeholder-layout {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
    }

    .tab-placeholder {
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      padding: 3rem;
      border: 1px solid var(--border-default);
      text-align: center;
      max-width: 480px;
      width: 100%;
    }

    .tab-placeholder h2 {
      font-size: 1.25rem;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
    }

    .tab-placeholder p {
      color: var(--text-secondary);
      font-size: 0.9375rem;
      line-height: 1.6;
      margin-bottom: 0.5rem;
    }

    .tab-placeholder .placeholder-amount {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
      margin-top: 1rem;
    }

    .card.full-width {
      grid-column: 1 / -1;
    }

    .projections-grid {
      display: grid;
      gap: 2rem;
    }

    .card {
      background: var(--card-gradient);
      border-radius: var(--radius-lg);
      padding: 1.75rem;
      border: 1px solid var(--border-default);
      position: relative;
      overflow: hidden;
      box-shadow: 0 1px 3px var(--shadow-color), 0 4px 12px rgba(0,0,0,0.08);
      transition: box-shadow var(--transition-base), transform var(--transition-base);
    }

    .card:hover {
      box-shadow: 0 2px 8px var(--shadow-color), 0 8px 24px rgba(0,0,0,0.12);
    }

    .card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--card-glow);
      pointer-events: none;
      border-radius: inherit;
    }

    .card h2 {
      font-size: 1.1875rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      color: var(--text-primary);
      position: relative;
      border-bottom: 1px solid var(--border-default);
      letter-spacing: -0.01em;
    }

    .form-group {
      margin-bottom: 1.375rem;
    }

    label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-wrapper .prefix,
    .input-wrapper .suffix {
      position: absolute;
      color: var(--text-muted);
      font-size: 0.8125rem;
      font-weight: 500;
      pointer-events: none;
      transition: color var(--transition-fast);
    }

    .input-wrapper .prefix {
      left: 14px;
    }

    .input-wrapper .suffix {
      right: 14px;
    }

    .input-wrapper:focus-within .prefix,
    .input-wrapper:focus-within .suffix {
      color: var(--accent);
    }

    input[type="number"] {
      width: 100%;
      padding: 0.75rem 0.875rem;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      font-size: 0.9375rem;
      font-weight: 500;
      font-family: inherit;
      transition: border-color var(--transition-base), box-shadow var(--transition-base), background var(--transition-base);
      -moz-appearance: textfield;
      background: var(--bg-input);
      color: var(--text-primary);
      box-shadow: inset 0 1px 2px var(--shadow-color);
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
    }

    input[type="number"]:hover:not(:disabled):not(:focus) {
      border-color: var(--border-strong);
    }

    input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--focus-ring), inset 0 1px 2px var(--shadow-color);
      background: var(--bg-input);
    }

    input[type="number"]:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    select {
      width: 100%;
      padding: 0.75rem 0.875rem;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      font-size: 0.9375rem;
      font-weight: 500;
      font-family: inherit;
      transition: border-color var(--transition-base), box-shadow var(--transition-base);
      background: var(--bg-input);
      color: var(--text-primary);
      cursor: pointer;
      box-shadow: inset 0 1px 2px var(--shadow-color);
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 2.25rem;
    }

    select:hover:not(:disabled):not(:focus) {
      border-color: var(--border-strong);
    }

    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--focus-ring), inset 0 1px 2px var(--shadow-color);
    }

    select option {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .computed-display {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-top: 0.375rem;
    }

    .computed-value {
      font-size: 1.0625rem;
      font-weight: 700;
      color: var(--accent);
      font-variant-numeric: tabular-nums;
    }

    .computed-note {
      font-size: 0.6875rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .input-section-header {
      font-size: 0.6875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.625rem 0.75rem;
      margin-top: 1.5rem;
      margin-bottom: 1rem;
      border-bottom: none;
      border-left: 3px solid currentColor;
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }

    .input-section-header:first-of-type {
      margin-top: 0;
    }

    .input-section-header.purchase {
      color: var(--accent);
      background: var(--accent-bg);
    }

    .input-section-header.expenses-input {
      color: var(--negative);
      background: var(--negative-bg);
    }

    .input-section-header.income-input {
      color: var(--color-primary-500);
      background: var(--accent-bg);
    }

    .has-prefix input {
      padding-left: 2rem;
    }

    .has-suffix input {
      padding-right: 2.5rem;
    }

    .results-card {
      align-self: start;
    }

    .results-card-standalone {
      align-self: start;
    }

    .section-header {
      font-size: 0.6875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.75rem 0 0.5rem;
      margin-top: 1rem;
      border-bottom: 2px solid var(--border-default);
    }

    .section-header:first-of-type {
      margin-top: 0;
    }

    .section-header.income {
      color: var(--color-primary-500);
      border-color: var(--section-border-primary);
    }

    .section-header.startup {
      color: var(--accent);
      border-color: var(--section-border-primary);
    }

    .section-header.monthly {
      color: var(--color-secondary-500);
      border-color: var(--section-border-secondary);
    }

    .section-header.expenses {
      color: var(--negative);
      border-color: var(--section-border-error);
    }

    .section-header.taxbenefit {
      color: var(--color-primary-500);
      border-color: var(--section-border-primary);
    }

    .section-header.results-heading {
      color: var(--accent);
      border-color: var(--section-border-primary);
    }

    .section-header.projection {
      color: var(--color-secondary-500);
      border-color: var(--section-border-secondary);
    }

    .section-header.cashflow {
      color: var(--color-primary-500);
      border-color: var(--section-border-primary);
    }

    .section-header.cashout {
      color: var(--text-secondary);
      border-color: var(--border-default);
    }

    .section-header.performance {
      color: var(--accent);
      border-color: var(--section-border-primary);
    }

    .section-header.offset {
      color: var(--color-warning);
      border-color: var(--section-border-warning);
    }

    .section-header.stocks {
      color: var(--color-secondary-500);
      border-color: var(--section-border-secondary);
    }

    .compare-table {
      width: 100%;
      border-collapse: collapse;
    }

    .compare-table th,
    .compare-table td {
      padding: 0.75rem 0.875rem;
      text-align: right;
      font-size: 0.875rem;
    }

    .compare-table th {
      font-size: 0.6875rem;
      font-weight: 700;
      color: var(--text-secondary);
      border-bottom: 2px solid var(--border-default);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .compare-table th:first-child,
    .compare-table td:first-child {
      text-align: left;
    }

    .compare-table td {
      border-bottom: 1px solid var(--border-default);
      color: var(--text-primary);
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .compare-table td:first-child {
      color: var(--text-secondary);
      font-weight: 500;
      font-variant-numeric: normal;
    }

    .compare-table .compare-section-row td {
      font-size: 0.6875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--color-secondary-500);
      border-bottom: 2px solid var(--section-border-secondary);
      padding-top: 1.5rem;
      padding-bottom: 0.625rem;
    }

    .compare-table .compare-section-row:first-child td {
      padding-top: 0.625rem;
    }

    .compare-toggle-row td {
      padding-top: 0.25rem;
      padding-bottom: 0.5rem;
      border-bottom: none;
    }

    .compare-toggle {
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.6875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      transition: color var(--transition-fast);
    }

    .compare-toggle:hover {
      color: var(--accent);
    }

    .compare-details-row td {
      padding-top: 0;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-default);
      font-weight: 400;
      vertical-align: top;
    }

    .compare-details-row td span {
      display: block;
      color: var(--text-muted);
      font-size: 0.75rem;
      line-height: 1.6;
    }

    .compare-details-row td strong {
      color: var(--text-secondary);
      font-weight: 600;
    }

    .compare-table .compare-scenario-start td {
      border-top: 2px solid var(--border-subtle);
    }

    .compare-table .compare-muted td {
      color: var(--text-muted);
      font-weight: 500;
    }
    .compare-table .compare-muted td:first-child {
      color: var(--text-muted);
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .toggle-row input[type="checkbox"] {
      -webkit-appearance: none;
      appearance: none;
      width: 32px;
      height: 18px;
      border-radius: 9px;
      background: var(--border-subtle);
      cursor: pointer;
      position: relative;
      transition: background var(--transition-base);
      flex-shrink: 0;
    }

    .toggle-row input[type="checkbox"]::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--text-primary);
      transition: transform var(--transition-base);
    }

    .toggle-row input[type="checkbox"]:checked {
      background: var(--accent);
    }

    .toggle-row input[type="checkbox"]:checked::after {
      transform: translateX(14px);
    }

    .toggle-row label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0;
      cursor: pointer;
      text-transform: none;
      font-weight: 400;
      letter-spacing: 0;
    }

    .line-item.muted .line-label {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .line-item.muted .line-value {
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
    }

    .line-item {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 0.5rem 0.5rem;
      margin: 0 -0.5rem;
      border-bottom: 1px solid var(--border-default);
      border-radius: var(--radius-sm);
      transition: background var(--transition-fast);
    }

    .line-item:hover {
      background: var(--accent-bg);
    }

    .line-item:last-child {
      border-bottom: none;
    }

    .line-label {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-weight: 400;
    }

    .help-tip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid var(--border-subtle);
      font-size: 0.5625rem;
      font-weight: 700;
      color: var(--text-muted);
      cursor: help;
      position: relative;
      flex-shrink: 0;
      transition: all var(--transition-fast);
    }

    .help-tip:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-bg);
    }

    .help-tip:hover::after {
      content: attr(data-tip);
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-surface);
      color: var(--text-primary);
      font-size: 0.6875rem;
      font-weight: 400;
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
      box-shadow: 0 4px 12px var(--shadow-color);
      white-space: nowrap;
      z-index: 10;
      line-height: 1.4;
    }

    .line-value {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }

    .line-value.positive {
      color: var(--positive);
    }

    .line-value.negative {
      color: var(--negative);
    }

    .line-item.total {
      border-top: 2px solid var(--border-subtle);
      border-bottom: none;
      padding-top: 0.75rem;
      margin-top: 0.25rem;
    }

    .line-item.total .line-label {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.8125rem;
    }

    .line-item.total .line-value {
      font-size: 1.0625rem;
      font-weight: 700;
    }

    .result-item {
      padding: 1.125rem 0;
      border-bottom: 1px solid var(--border-default);
    }

    .result-item:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .result-label {
      font-size: 0.6875rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.375rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .result-value {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--text-primary);
      letter-spacing: -0.02em;
      font-variant-numeric: tabular-nums;
      line-height: 1.2;
    }

    .result-value.positive {
      color: var(--positive);
    }

    .result-value.negative {
      color: var(--negative);
    }

    .result-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.375rem;
      font-weight: 400;
    }

    /* Utility classes */
    .text-muted { color: var(--text-muted); }
    .positive { color: var(--positive); }
    .negative { color: var(--negative); }

    /* Mismatch warning */
    .mismatch-warning {
      display: none;
      background: var(--bg-elevated);
      border: 1px solid var(--section-border-warning);
      border-left: 3px solid var(--color-warning);
      border-radius: var(--radius-sm);
      padding: 0.75rem 1rem;
      margin-bottom: 1.25rem;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--color-warning);
      line-height: 1.5;
    }

    /* Mobile-first: base styles (< 768px) — horizontal sidebar */
    .app-layout {
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 80px);
    }

    .sidebar {
      width: 100%;
      min-width: 0;
      flex-direction: row;
      overflow-x: auto;
      padding: 0;
      border-right: none;
      border-bottom: 1px solid var(--border-default);
    }

    .sidebar-tab {
      border-left: none;
      border-bottom: 3px solid transparent;
      padding: 0.75rem 1rem;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .sidebar-tab.active {
      border-left-color: transparent;
      border-bottom-color: var(--accent);
    }

    .sidebar-shared-value {
      margin-top: 0;
      margin-left: auto;
      border-top: none;
      border-left: 1px solid var(--border-default);
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 0.75rem;
      flex-shrink: 0;
    }

    .sidebar-shared-value .shared-label {
      margin-bottom: 0;
      white-space: nowrap;
    }

    .sidebar-shared-value .sidebar-input {
      min-width: 100px;
      max-width: 130px;
    }

    .sidebar-shared-value .sidebar-input input {
      font-size: 0.8125rem;
      padding: 0.25rem 0.375rem;
    }

    .tab-content.active {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .tab-content.active.two-col-layout {
      grid-template-columns: 1fr;
    }

    .projections-grid {
      grid-template-columns: 1fr;
    }

    /* 768px+ — vertical sidebar, 2-col for two-col-layout tabs */
    @media (min-width: 768px) {
      .app-layout {
        flex-direction: row;
      }

      .sidebar {
        width: 200px;
        min-width: 200px;
        flex-direction: column;
        overflow-x: visible;
        padding: 1rem 0;
        border-right: 1px solid var(--border-default);
        border-bottom: none;
      }

      .sidebar-tab {
        border-bottom: none;
        border-left: 3px solid transparent;
        padding: 0.75rem 1.25rem;
        white-space: normal;
        flex-shrink: 1;
      }

      .sidebar-tab.active {
        border-bottom-color: transparent;
        border-left-color: var(--accent);
      }

      .sidebar-shared-value {
        margin-top: 1rem;
        margin-left: 0;
        border-left: none;
        border-top: 1px solid var(--border-default);
        display: block;
        padding: 1rem 1.25rem;
      }

      .sidebar-shared-value .shared-label {
        margin-bottom: 0.375rem;
        display: block;
      }

      .sidebar-shared-value .sidebar-input {
        min-width: 0;
        max-width: none;
      }

      .sidebar-shared-value .sidebar-input input {
        font-size: 0.9375rem;
        padding: 0.375rem 0.5rem;
      }

      .tab-content.active.two-col-layout {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* 1024px+ — main tab 2 columns, projections 2-col */
    @media (min-width: 1024px) {
      .tab-content.active {
        grid-template-columns: 1fr 1fr;
      }

      .projections-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* 1280px+ — main tab 3 columns, projections 3-col */
    @media (min-width: 1280px) {
      .tab-content.active {
        grid-template-columns: 1fr 1fr 1fr;
      }

      .projections-grid {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div>
        <h1><svg width="28" height="32" viewBox="0 0 28 32" style="vertical-align: middle; margin-right: 0.5rem;"><path d="M14 1L2 6v10c0 8.5 5.1 16.4 12 19 6.9-2.6 12-10.5 12-19V6L14 1z" fill="none" stroke="currentColor" stroke-width="2"/><text x="14" y="20" text-anchor="middle" font-size="11" font-weight="700" fill="currentColor" font-family="inherit">TR</text></svg>TrueReturn</h1>
        <p>Investment Comparison Tool</p>
      </div>
      <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
        <svg class="theme-icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <svg class="theme-icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
      </button>
    </div>
  </header>

  <div class="app-layout">
    <nav class="sidebar">
      <button class="sidebar-tab active" data-tab="tab-property">
        <span class="sidebar-icon"><svg viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1h-2z"/></svg></span>
        Property
      </button>
      <button class="sidebar-tab" data-tab="tab-offset">
        <span class="sidebar-icon"><svg viewBox="0 0 24 24"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg></span>
        Offset
      </button>
      <button class="sidebar-tab" data-tab="tab-stocks">
        <span class="sidebar-icon"><svg viewBox="0 0 24 24"><path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg></span>
        Stocks / ETFs
      </button>
      <button class="sidebar-tab" data-tab="tab-compare">
        <span class="sidebar-icon"><svg viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></span>
        Compare
      </button>
      <div class="sidebar-shared-value">
        <label class="shared-label" for="globalCashInvestment">Total Cash Investment</label>
        <div class="input-wrapper has-prefix sidebar-input">
          <span class="prefix">$</span>
          <input type="number" id="globalCashInvestment" value="60000" min="0" step="1000">
        </div>
      </div>
    </nav>

    <main class="content-area">
      <section id="tab-property" class="tab-content active">
        <div class="card">
      <h2>Property Purchase Details</h2>

      <!-- Purchase section -->
      <div class="input-section-header purchase">Purchase</div>

      <div class="form-group">
        <label for="purchasePrice">Purchase Price</label>
        <div class="input-wrapper has-prefix">
          <span class="prefix">$</span>
          <input type="number" id="purchasePrice" value="295000" min="0" step="1000">
        </div>
        <div class="toggle-row">
          <input type="checkbox" id="useGlobalCashProperty" checked>
          <label for="useGlobalCashProperty">Use Total Cash Investment</label>
        </div>
      </div>

      <div class="form-group">
        <label for="depositPct">Deposit</label>
        <div class="input-wrapper has-suffix">
          <input type="number" id="depositPct" value="20" min="0" max="100" step="1">
          <span class="suffix">%</span>
        </div>
        <div class="computed-display">
          <span class="computed-value" id="resDepositAmount">$0</span>
        </div>
      </div>

      <div class="form-group">
        <label for="loanType">Loan Type</label>
        <select id="loanType">
          <option value="IO">Interest Only</option>
          <option value="PI" selected>Principal & Interest</option>
        </select>
      </div>

      <div class="form-group" id="loanTermGroup">
        <label for="loanTerm">Loan Term</label>
        <div class="input-wrapper has-suffix">
          <input type="number" id="loanTerm" value="30" min="1" max="40" step="1">
          <span class="suffix">yrs</span>
        </div>
      </div>

      <div class="form-group">
        <label for="state">State</label>
        <select id="state">
          <option value="NSW">New South Wales</option>
          <option value="VIC">Victoria</option>
          <option value="QLD" selected>Queensland</option>
          <option value="SA">South Australia</option>
          <option value="WA">Western Australia</option>
          <option value="TAS">Tasmania</option>
          <option value="ACT">Australian Capital Territory</option>
          <option value="NT">Northern Territory</option>
        </select>
        <div class="computed-display">
          <span class="help-tip" data-tip="Populates values based on state averages">?</span>
          <span class="computed-note">Populates values based on state averages</span>
        </div>
      </div>

      <div class="form-group">
        <label for="interestRate">Interest Rate</label>
        <div class="input-wrapper has-suffix">
          <input type="number" id="interestRate" value="5.89" min="0" max="20" step="0.01">
          <span class="suffix">%</span>
        </div>
      </div>

      <!-- Expenses section -->
      <div class="input-section-header expenses-input">Expenses</div>

      <div class="form-group">
        <label for="managementFee">Property Management Fee</label>
        <div class="input-wrapper has-suffix">
          <input type="number" id="managementFee" value="6.6" min="0" max="100" step="0.1">
          <span class="suffix">%</span>
        </div>
      </div>

      <!-- Income section -->
      <div class="input-section-header income-input">Income</div>

      <div class="form-group">
        <label for="weeklyRent">Expected Weekly Rent</label>
        <div class="input-wrapper has-prefix">
          <span class="prefix">$</span>
          <input type="number" id="weeklyRent" value="420" min="0" step="10">
        </div>
      </div>
    </div>

    <div class="card results-card">
      <h2>Breakdown</h2>

      <!-- Income -->
      <div class="section-header income">Income</div>
      <div class="line-item">
        <span class="line-label">Weekly Rent</span>
        <span class="line-value" id="resWeeklyRent">-</span>
      </div>
      <div class="line-item total">
        <span class="line-label">Annual Rent</span>
        <span class="line-value" id="resAnnualRent">-</span>
      </div>

      <!-- Start Up Expenses -->
      <div class="section-header startup">Start Up Expenses</div>
      <div class="line-item">
        <span class="line-label">Deposit</span>
        <span class="line-value" id="resDeposit">-</span>
      </div>
      <div class="line-item">
        <span class="line-label">Stamp Duty <span class="help-tip" data-tip="Based on state selected">?</span></span>
        <span class="line-value" id="resStampDuty">-</span>
      </div>
      <div class="line-item">
        <span class="line-label">Conveyancing <span class="help-tip" data-tip="Based on averages for state selected">?</span></span>
        <span class="line-value" id="resConveyancing">-</span>
      </div>
      <div class="line-item total">
        <span class="line-label">Total Cash Investment</span>
        <span class="line-value" id="resTotalUpfront">-</span>
      </div>

      <!-- Month-to-Month Picture -->
      <div class="section-header monthly">Month-to-Month Picture</div>
      <div class="line-item">
        <span class="line-label">Rent In</span>
        <span class="line-value positive" id="resMonthlyRent">-</span>
      </div>
      <div class="line-item">
        <span class="line-label">Property Management</span>
        <span class="line-value" id="resMonthlyMgmt">-</span>
      </div>
      <div class="line-item">
        <span class="line-label">Loan Payment</span>
        <span class="line-value" id="resMonthlyLoan">-</span>
      </div>
      <div class="line-item total">
        <span class="line-label">Monthly Cash Flow</span>
        <span class="line-value" id="resMonthlyCashFlow">-</span>
      </div>

      <!-- Annual Expenses -->
      <div class="section-header expenses">Annual Expenses</div>
      <div class="line-item">
        <span class="line-label">Loan Payment</span>
        <span class="line-value" id="resLoanPayment">-</span>
      </div>
      <div id="loanBreakdown" style="display: flex; flex-direction: column; align-items: flex-end; margin-top: -0.25rem; margin-bottom: 0.25rem;">
        <span class="computed-note" id="resPrincipalPortion">-</span>
        <span class="computed-note" id="resInterestPortion">-</span>
      </div>
      <div class="line-item">
        <span class="line-label">Property Management</span>
        <span class="line-value" id="resManagement">-</span>
      </div>
      <div class="line-item">
        <span class="line-label">Insurance <span class="help-tip" data-tip="Based on averages for state selected">?</span></span>
        <span class="line-value" id="resInsurance">-</span>
      </div>
      <div class="line-item">
        <span class="line-label">Council Rates</span>
        <span class="line-value" id="resCouncil">-</span>
      </div>
      <div class="line-item">
        <span class="line-label">Vacancy Allowance <span class="help-tip" data-tip="Assumed 2 weeks per year">?</span></span>
        <span class="line-value" id="resVacancy">-</span>
      </div>
      <div class="line-item">
        <span class="line-label">Maintenance Allowance <span class="help-tip" data-tip="Estimated at 0.5% of property value">?</span></span>
        <span class="line-value" id="resMaintenance">-</span>
      </div>
      <div class="line-item total">
        <span class="line-label">Total Annual Expenses</span>
        <span class="line-value" id="resTotalExpenses">-</span>
      </div>
      <div class="line-item muted">
        <span class="line-label">Total Annual Expenses incl Tax Benefit</span>
        <span class="line-value" id="resTotalExpensesAfterTax">-</span>
      </div>

      <!-- Tax Benefit -->
      <div class="section-header taxbenefit">Potential Tax Benefit</div>
      <div class="line-item muted">
        <span class="line-label">Deductible Expenses</span>
        <span class="line-value" id="resDeductible">-</span>
      </div>
      <div class="line-item muted">
        <span class="line-label">Net Rental Position <span class="help-tip" data-tip="Annual rent minus deductible expenses. If negative, the loss can offset your taxable income (negative gearing).">?</span></span>
        <span class="line-value" id="resNetRental">-</span>
      </div>
      <div class="line-item">
        <span class="line-label">Est. Tax Benefit <span class="help-tip" data-tip="Assumed 30% marginal tax rate. Actual rate depends on your taxable income.">?</span></span>
        <span class="line-value positive" id="resTaxBenefit">-</span>
      </div>
      <div class="computed-note" style="margin-top: 0.5rem; line-height: 1.4;">Deductible expenses include loan interest, property management, insurance, council rates, and maintenance. If these exceed rental income, the loss can be offset against your other taxable income (negative gearing). The benefit is estimated at 30% of the rental loss. Does not include depreciation. Note: potential tax benefit is not included in Annual Cash Flow as it depends heavily on your individual tax situation.</div>
    </div>

    <div class="card results-card-standalone">
      <h2>Results</h2>

      <div class="result-item">
        <div class="result-label">Annual Cash Flow</div>
        <div class="result-value" id="annualCashFlow">-</div>
        <div class="result-sub" id="monthlyCashFlow"></div>
        <div class="computed-note" style="margin-top: 0.5rem; line-height: 1.4;">Includes annual rent income minus loan payments, property management, insurance, council rates, vacancy allowance, and maintenance.</div>
      </div>

      <div class="result-item">
        <div class="result-label">Gross Yield</div>
        <div class="result-value" id="grossYield">-</div>
        <div class="result-sub">Annual rent / purchase price</div>
        <div class="computed-note" style="margin-top: 0.5rem; line-height: 1.4;">A gross rental yield of 5% or higher is often considered strong for residential property. Capital city yields commonly sit around 3–5%, while regional properties may achieve 5–8% or more. Yields below 4% may suggest the property is priced for growth rather than income.</div>
      </div>

      <div class="result-item">
        <div class="result-label">Net Yield</div>
        <div class="result-value" id="netYield">-</div>
        <div class="result-sub">After all expenses</div>
        <div class="computed-note" style="margin-top: 0.5rem; line-height: 1.4;">Net yield measures rental return after costs and is a more realistic indicator of cash flow than gross yield.</div>
      </div>

    </div>

    <div class="card full-width">
      <h2>Projections</h2>

      <div class="form-group" style="max-width: 460px;">
        <label for="expectedGrowth">Expected Annual Growth</label>
        <div class="input-wrapper has-suffix" style="max-width: 260px;">
          <input type="number" id="expectedGrowth" value="3" min="-20" max="50" step="0.5">
          <span class="suffix">%</span>
        </div>
        <div class="computed-note" style="margin-top: 0.5rem; line-height: 1.4;">Australian residential property prices have grown at approximately 6–7% per year over the past 20 years, but returns vary significantly by location and market cycle. Past performance does not guarantee future results.</div>
      </div>

      <div class="projections-grid">
        <!-- 5 Year -->
        <div>
          <div class="section-header projection">5 Year</div>
          <div class="line-item">
            <span class="line-label">Property Value</span>
            <span class="line-value" id="proj5Value">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Capital Growth</span>
            <span class="line-value" id="proj5Growth">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Principal Paid Down</span>
            <span class="line-value" id="proj5Principal">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Remaining Loan</span>
            <span class="line-value" id="proj5Loan">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Equity</span>
            <span class="line-value" id="proj5Equity">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Usable Equity <span class="help-tip" data-tip="80% of total equity — the maximum most banks will lend against">?</span></span>
            <span class="line-value" id="proj5UsableEquity">-</span>
          </div>

          <div class="section-header cashflow">Cash Flow</div>
          <div class="line-item">
            <span class="line-label">Est. Weekly Rent <span class="help-tip" data-tip="Rent increases in line with property value growth">?</span></span>
            <span class="line-value" id="proj5Rent">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Est. Annual Cash Flow</span>
            <span class="line-value" id="proj5CashFlow">-</span>
          </div>

          <div class="section-header cashout">Cash Out Position</div>
          <div class="line-item">
            <span class="line-label">Sale Price</span>
            <span class="line-value" id="proj5Sale">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Sales Costs <span class="help-tip" data-tip="Estimated at 3% of sale price (agent fees, legal, marketing)">?</span></span>
            <span class="line-value" id="proj5SaleCosts">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Remaining Loan Payout</span>
            <span class="line-value" id="proj5LoanPayout">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Net Proceeds Before Tax</span>
            <span class="line-value" id="proj5NetProceeds">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Capital Gains Tax <span class="help-tip" data-tip="50% CGT discount applied. Assumed 30% marginal tax rate based on median Australian salary. Actual rate depends on your taxable income.">?</span></span>
            <span class="line-value" id="proj5CGT">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">True Cash Return</span>
            <span class="line-value" id="proj5TrueReturn">-</span>
          </div>

          <div class="section-header performance">Investment Performance</div>
          <div class="line-item muted">
            <span class="line-label">Total Cash Invested <span class="help-tip" data-tip="Deposit + stamp duty + conveyancing">?</span></span>
            <span class="line-value" id="proj5CashInvested">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Cumulative Cash Flow <span class="help-tip" data-tip="Total rent income minus expenses over the period">?</span></span>
            <span class="line-value" id="proj5CumCashFlow">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Total Profit <span class="help-tip" data-tip="True cash return minus cash invested, plus cumulative cash flow">?</span></span>
            <span class="line-value" id="proj5TotalProfit">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Total Cash Return % <span class="help-tip" data-tip="Total profit as a percentage of cash invested">?</span></span>
            <span class="line-value" id="proj5ReturnOnCash">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Annual Cash Return % <span class="help-tip" data-tip="Equivalent annual return rate — compare against shares or index funds">?</span></span>
            <span class="line-value" id="proj5AnnualisedReturn">-</span>
          </div>
        </div>

        <!-- 10 Year -->
        <div>
          <div class="section-header projection">10 Year</div>
          <div class="line-item">
            <span class="line-label">Property Value</span>
            <span class="line-value" id="proj10Value">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Capital Growth</span>
            <span class="line-value" id="proj10Growth">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Principal Paid Down</span>
            <span class="line-value" id="proj10Principal">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Remaining Loan</span>
            <span class="line-value" id="proj10Loan">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Equity</span>
            <span class="line-value" id="proj10Equity">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Usable Equity <span class="help-tip" data-tip="80% of total equity — the maximum most banks will lend against">?</span></span>
            <span class="line-value" id="proj10UsableEquity">-</span>
          </div>

          <div class="section-header cashflow">Cash Flow</div>
          <div class="line-item">
            <span class="line-label">Est. Weekly Rent <span class="help-tip" data-tip="Rent increases in line with property value growth">?</span></span>
            <span class="line-value" id="proj10Rent">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Est. Annual Cash Flow</span>
            <span class="line-value" id="proj10CashFlow">-</span>
          </div>

          <div class="section-header cashout">Cash Out Position</div>
          <div class="line-item">
            <span class="line-label">Sale Price</span>
            <span class="line-value" id="proj10Sale">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Sales Costs <span class="help-tip" data-tip="Estimated at 3% of sale price (agent fees, legal, marketing)">?</span></span>
            <span class="line-value" id="proj10SaleCosts">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Remaining Loan Payout</span>
            <span class="line-value" id="proj10LoanPayout">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Net Proceeds Before Tax</span>
            <span class="line-value" id="proj10NetProceeds">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Capital Gains Tax <span class="help-tip" data-tip="50% CGT discount applied. Assumed 30% marginal tax rate based on median Australian salary. Actual rate depends on your taxable income.">?</span></span>
            <span class="line-value" id="proj10CGT">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">True Cash Return</span>
            <span class="line-value" id="proj10TrueReturn">-</span>
          </div>

          <div class="section-header performance">Investment Performance</div>
          <div class="line-item muted">
            <span class="line-label">Total Cash Invested <span class="help-tip" data-tip="Deposit + stamp duty + conveyancing">?</span></span>
            <span class="line-value" id="proj10CashInvested">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Cumulative Cash Flow <span class="help-tip" data-tip="Total rent income minus expenses over the period">?</span></span>
            <span class="line-value" id="proj10CumCashFlow">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Total Profit <span class="help-tip" data-tip="True cash return minus cash invested, plus cumulative cash flow">?</span></span>
            <span class="line-value" id="proj10TotalProfit">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Total Cash Return % <span class="help-tip" data-tip="Total profit as a percentage of cash invested">?</span></span>
            <span class="line-value" id="proj10ReturnOnCash">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Annual Cash Return % <span class="help-tip" data-tip="Equivalent annual return rate — compare against shares or index funds">?</span></span>
            <span class="line-value" id="proj10AnnualisedReturn">-</span>
          </div>
        </div>

        <!-- Lifetime -->
        <div>
          <div class="section-header projection" id="projLifeHeader">Lifetime</div>
          <div class="line-item">
            <span class="line-label">Property Value</span>
            <span class="line-value" id="projLifeValue">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Capital Growth</span>
            <span class="line-value" id="projLifeGrowth">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Principal Paid Down</span>
            <span class="line-value" id="projLifePrincipal">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Remaining Loan</span>
            <span class="line-value" id="projLifeLoan">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Equity</span>
            <span class="line-value" id="projLifeEquity">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Usable Equity <span class="help-tip" data-tip="80% of total equity — the maximum most banks will lend against">?</span></span>
            <span class="line-value" id="projLifeUsableEquity">-</span>
          </div>

          <div class="section-header cashflow">Cash Flow</div>
          <div class="line-item">
            <span class="line-label">Est. Weekly Rent <span class="help-tip" data-tip="Rent increases in line with property value growth">?</span></span>
            <span class="line-value" id="projLifeRent">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Est. Annual Cash Flow</span>
            <span class="line-value" id="projLifeCashFlow">-</span>
          </div>

          <div class="section-header cashout">Cash Out Position</div>
          <div class="line-item">
            <span class="line-label">Sale Price</span>
            <span class="line-value" id="projLifeSale">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Sales Costs <span class="help-tip" data-tip="Estimated at 3% of sale price (agent fees, legal, marketing)">?</span></span>
            <span class="line-value" id="projLifeSaleCosts">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Remaining Loan Payout</span>
            <span class="line-value" id="projLifeLoanPayout">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Net Proceeds Before Tax</span>
            <span class="line-value" id="projLifeNetProceeds">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Capital Gains Tax <span class="help-tip" data-tip="50% CGT discount applied. Assumed 30% marginal tax rate based on median Australian salary. Actual rate depends on your taxable income.">?</span></span>
            <span class="line-value" id="projLifeCGT">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">True Cash Return</span>
            <span class="line-value" id="projLifeTrueReturn">-</span>
          </div>

          <div class="section-header performance">Investment Performance</div>
          <div class="line-item muted">
            <span class="line-label">Total Cash Invested <span class="help-tip" data-tip="Deposit + stamp duty + conveyancing">?</span></span>
            <span class="line-value" id="projLifeCashInvested">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Cumulative Cash Flow <span class="help-tip" data-tip="Total rent income minus expenses over the period">?</span></span>
            <span class="line-value" id="projLifeCumCashFlow">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Total Profit <span class="help-tip" data-tip="True cash return minus cash invested, plus cumulative cash flow">?</span></span>
            <span class="line-value" id="projLifeTotalProfit">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Total Cash Return % <span class="help-tip" data-tip="Total profit as a percentage of cash invested">?</span></span>
            <span class="line-value" id="projLifeReturnOnCash">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Annual Cash Return % <span class="help-tip" data-tip="Equivalent annual return rate — compare against shares or index funds">?</span></span>
            <span class="line-value" id="projLifeAnnualisedReturn">-</span>
          </div>
        </div>
      </div>
        </div>
      </section>

      <section id="tab-offset" class="tab-content two-col-layout">
        <div class="card">
          <h2>Offset Details</h2>

          <div class="form-group">
            <label for="offsetAmount">Offset Amount</label>
            <div class="input-wrapper has-prefix">
              <span class="prefix">$</span>
              <input type="number" id="offsetAmount" value="69900" min="0" step="1000">
            </div>
            <div class="toggle-row">
              <input type="checkbox" id="usePropertyUpfront" checked>
              <label for="usePropertyUpfront">Use Total Cash Investment</label>
            </div>
          </div>

          <div class="form-group">
            <label for="offsetLoanBalance">Loan Balance</label>
            <div class="input-wrapper has-prefix">
              <span class="prefix">$</span>
              <input type="number" id="offsetLoanBalance" value="600000" min="0" step="1000">
            </div>
          </div>

          <div class="form-group">
            <label for="offsetInterestRate">Interest Rate</label>
            <div class="input-wrapper has-suffix">
              <input type="number" id="offsetInterestRate" value="5.89" min="0" max="20" step="0.01">
              <span class="suffix">%</span>
            </div>
            <div class="toggle-row">
              <input type="checkbox" id="usePropertyRate" checked>
              <label for="usePropertyRate">Use Property Rate</label>
            </div>
          </div>

          <div class="form-group">
            <label for="offsetLoanType">Loan Type</label>
            <select id="offsetLoanType">
              <option value="IO">Interest Only</option>
              <option value="PI" selected>Principal & Interest</option>
            </select>
          </div>

          <div class="form-group" id="offsetLoanTermGroup">
            <label for="offsetLoanTerm">Loan Term</label>
            <div class="input-wrapper has-suffix">
              <input type="number" id="offsetLoanTerm" value="30" min="1" max="40" step="1">
              <span class="suffix">yrs</span>
            </div>
          </div>
        </div>

        <div class="card results-card">
          <h2>Interest Saved</h2>

          <div class="result-item">
            <div class="result-label">Effective Return</div>
            <div class="result-value positive" id="offsetEffectiveReturn">-</div>
            <div class="computed-note" style="margin-top: 0.375rem; line-height: 1.4;">Every dollar in an offset account saves you the loan interest rate in interest, tax-free. This is equivalent to earning the rate in a savings account before tax.</div>
          </div>

          <div class="line-item" id="offsetTimeSavedRow">
            <span class="line-label">Time Saved on Loan <span class="help-tip" data-tip="How much sooner the loan is fully paid off with the offset (P&I only)">?</span></span>
            <span class="line-value positive" id="offsetTimeSaved">-</span>
          </div>

          <div class="section-header offset">5 Year</div>
          <div class="line-item">
            <span class="line-label">Without Offset</span>
            <span class="line-value" id="offsetNoOffset5">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">With Offset</span>
            <span class="line-value" id="offsetWithOffset5">-</span>
          </div>
          <div class="line-item total">
            <span class="line-label">Interest Saved</span>
            <span class="line-value positive" id="offsetSaved5">-</span>
          </div>

          <div class="section-header offset">10 Year</div>
          <div class="line-item">
            <span class="line-label">Without Offset</span>
            <span class="line-value" id="offsetNoOffset10">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">With Offset</span>
            <span class="line-value" id="offsetWithOffset10">-</span>
          </div>
          <div class="line-item total">
            <span class="line-label">Interest Saved</span>
            <span class="line-value positive" id="offsetSaved10">-</span>
          </div>

          <div class="section-header offset" id="offsetLifeHeader">Lifetime</div>
          <div class="line-item">
            <span class="line-label">Without Offset</span>
            <span class="line-value" id="offsetNoOffsetLife">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">With Offset</span>
            <span class="line-value" id="offsetWithOffsetLife">-</span>
          </div>
          <div class="line-item total">
            <span class="line-label">Interest Saved</span>
            <span class="line-value positive" id="offsetSavedLifetime">-</span>
          </div>
        </div>
      </section>

      <section id="tab-stocks" class="tab-content two-col-layout">
        <div class="card">
          <h2>Investment Details</h2>

          <div class="form-group">
            <label for="stocksAmount">Investment Amount</label>
            <div class="input-wrapper has-prefix">
              <span class="prefix">$</span>
              <input type="number" id="stocksAmount" value="0" min="0" step="1000">
            </div>
            <div class="toggle-row">
              <input type="checkbox" id="usePropertyUpfrontStocks" checked>
              <label for="usePropertyUpfrontStocks">Use Total Cash Investment</label>
            </div>
          </div>

          <div class="form-group">
            <label for="stocksType">Investment Type</label>
            <select id="stocksType">
              <option value="ASX200">ASX 200</option>
              <option value="SP500">S&P 500</option>
              <option value="HighGrowth">High-Growth ETF</option>
              <option value="Custom">Custom</option>
            </select>
            <div class="computed-note" id="stocksTypeNote" style="margin-top: 0.5rem; line-height: 1.4;"></div>
          </div>

          <div class="form-group">
            <label for="stocksGrowth">Annual Growth</label>
            <div class="input-wrapper has-suffix">
              <input type="number" id="stocksGrowth" value="7" min="-50" max="100" step="0.5" disabled>
              <span class="suffix">%</span>
            </div>
          </div>

          <div class="form-group">
            <label for="stocksDividend">Dividend Yield</label>
            <div class="input-wrapper has-suffix">
              <input type="number" id="stocksDividend" value="4" min="0" max="100" step="0.5" disabled>
              <span class="suffix">%</span>
            </div>
          </div>

          <div class="form-group">
            <div class="toggle-row" style="margin-top: 0;">
              <input type="checkbox" id="stocksReinvest" checked>
              <label for="stocksReinvest">Reinvest Dividends</label>
            </div>
          </div>

          <div class="form-group">
            <label for="stocksPeriod">Investment Period</label>
            <div class="input-wrapper has-suffix">
              <input type="number" id="stocksPeriod" value="30" min="1" max="50" step="1">
              <span class="suffix">yrs</span>
            </div>
            <div class="toggle-row">
              <input type="checkbox" id="usePropertyTermStocks" checked>
              <label for="usePropertyTermStocks">Use Property Loan Term</label>
            </div>
          </div>
        </div>

        <div class="card results-card">
          <h2>Investment Returns</h2>

          <div class="result-item">
            <div class="result-label">Total Return p.a.</div>
            <div class="result-value positive" id="stocksTotalReturnPA">-</div>
          </div>

          <div class="section-header stocks">5 Year</div>
          <div class="line-item">
            <span class="line-label">Portfolio Value</span>
            <span class="line-value" id="stocks5Portfolio">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Capital Growth</span>
            <span class="line-value" id="stocks5Growth">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Dividends Earned</span>
            <span class="line-value" id="stocks5Dividends">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Total Value</span>
            <span class="line-value" id="stocks5TotalValue">-</span>
          </div>
          <div class="line-item total">
            <span class="line-label">Total Return</span>
            <span class="line-value" id="stocks5Return">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Conservative</span>
            <span class="line-value" id="stocks5ConsReturn">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Worst Case</span>
            <span class="line-value" id="stocks5WorstReturn">-</span>
          </div>

          <div class="section-header stocks">10 Year</div>
          <div class="line-item">
            <span class="line-label">Portfolio Value</span>
            <span class="line-value" id="stocks10Portfolio">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Capital Growth</span>
            <span class="line-value" id="stocks10Growth">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Dividends Earned</span>
            <span class="line-value" id="stocks10Dividends">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Total Value</span>
            <span class="line-value" id="stocks10TotalValue">-</span>
          </div>
          <div class="line-item total">
            <span class="line-label">Total Return</span>
            <span class="line-value" id="stocks10Return">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Conservative</span>
            <span class="line-value" id="stocks10ConsReturn">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Worst Case</span>
            <span class="line-value" id="stocks10WorstReturn">-</span>
          </div>

          <div class="section-header stocks" id="stocksLifeHeader">Lifetime</div>
          <div class="line-item">
            <span class="line-label">Portfolio Value</span>
            <span class="line-value" id="stocksLifePortfolio">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Capital Growth</span>
            <span class="line-value" id="stocksLifeGrowth">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Dividends Earned</span>
            <span class="line-value" id="stocksLifeDividends">-</span>
          </div>
          <div class="line-item">
            <span class="line-label">Total Value</span>
            <span class="line-value" id="stocksLifeTotalValue">-</span>
          </div>
          <div class="line-item total">
            <span class="line-label">Total Return</span>
            <span class="line-value" id="stocksLifeReturn">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Conservative</span>
            <span class="line-value" id="stocksLifeConsReturn">-</span>
          </div>
          <div class="line-item muted">
            <span class="line-label">Worst Case</span>
            <span class="line-value" id="stocksLifeWorstReturn">-</span>
          </div>
        </div>
      </section>

      <section id="tab-compare" class="tab-content">
        <div class="card full-width">
          <h2>Compare Investments</h2>
          <div id="cmpMismatchWarning" class="mismatch-warning">
            <span style="margin-right: 0.375rem;">&#9888;</span>
            <span id="cmpMismatchText"></span>
          </div>
          <table class="compare-table">
            <thead>
              <tr>
                <th></th>
                <th>Property<br><span style="font-weight:400;">Total Profit</span></th>
                <th>Offset<br><span style="font-weight:400;">Interest Saved</span></th>
                <th>Stocks / ETFs<br><span style="font-weight:400;">Total Return</span></th>
              </tr>
            </thead>
            <tbody>
              <tr class="compare-toggle-row">
                <td colspan="4"><span class="compare-toggle" id="cmpDetailsToggle">+ Assumptions</span></td>
              </tr>
              <tr class="compare-details-row" id="cmpDetailsRow" style="display: none;">
                <td></td>
                <td id="cmpDetailsProperty"></td>
                <td id="cmpDetailsOffset"></td>
                <td id="cmpDetailsStocks"></td>
              </tr>
              <tr class="compare-section-row">
                <td colspan="4">5 Year</td>
              </tr>
              <tr>
                <td>Return</td>
                <td id="cmp5Property">-</td>
                <td id="cmp5Offset">-</td>
                <td id="cmp5Stocks">-</td>
              </tr>
              <tr>
                <td>Annualised</td>
                <td id="cmp5PropertyAnn">-</td>
                <td id="cmp5OffsetAnn">-</td>
                <td id="cmp5StocksAnn">-</td>
              </tr>
              <tr class="compare-scenario-start compare-muted">
                <td>Conservative<div class="computed-note" id="cmp5ConsTip"></div></td>
                <td id="cmp5PropertyCons">-</td>
                <td id="cmp5OffsetCons">-</td>
                <td id="cmp5StocksCons">-</td>
              </tr>
              <tr class="compare-muted">
                <td>Annualised</td>
                <td id="cmp5PropertyConsAnn">-</td>
                <td id="cmp5OffsetConsAnn">-</td>
                <td id="cmp5StocksConsAnn">-</td>
              </tr>
              <tr class="compare-muted">
                <td>Worst Case<div class="computed-note" id="cmp5WorstTip"></div></td>
                <td id="cmp5PropertyWorst">-</td>
                <td id="cmp5OffsetWorst">-</td>
                <td id="cmp5StocksWorst">-</td>
              </tr>
              <tr class="compare-muted">
                <td>Annualised</td>
                <td id="cmp5PropertyWorstAnn">-</td>
                <td id="cmp5OffsetWorstAnn">-</td>
                <td id="cmp5StocksWorstAnn">-</td>
              </tr>
              <tr class="compare-section-row">
                <td colspan="4">10 Year</td>
              </tr>
              <tr>
                <td>Return</td>
                <td id="cmp10Property">-</td>
                <td id="cmp10Offset">-</td>
                <td id="cmp10Stocks">-</td>
              </tr>
              <tr>
                <td>Annualised</td>
                <td id="cmp10PropertyAnn">-</td>
                <td id="cmp10OffsetAnn">-</td>
                <td id="cmp10StocksAnn">-</td>
              </tr>
              <tr class="compare-scenario-start compare-muted">
                <td>Conservative<div class="computed-note" id="cmp10ConsTip"></div></td>
                <td id="cmp10PropertyCons">-</td>
                <td id="cmp10OffsetCons">-</td>
                <td id="cmp10StocksCons">-</td>
              </tr>
              <tr class="compare-muted">
                <td>Annualised</td>
                <td id="cmp10PropertyConsAnn">-</td>
                <td id="cmp10OffsetConsAnn">-</td>
                <td id="cmp10StocksConsAnn">-</td>
              </tr>
              <tr class="compare-muted">
                <td>Worst Case<div class="computed-note" id="cmp10WorstTip"></div></td>
                <td id="cmp10PropertyWorst">-</td>
                <td id="cmp10OffsetWorst">-</td>
                <td id="cmp10StocksWorst">-</td>
              </tr>
              <tr class="compare-muted">
                <td>Annualised</td>
                <td id="cmp10PropertyWorstAnn">-</td>
                <td id="cmp10OffsetWorstAnn">-</td>
                <td id="cmp10StocksWorstAnn">-</td>
              </tr>
              <tr class="compare-section-row">
                <td colspan="4" id="cmpLifeHeader">Lifetime</td>
              </tr>
              <tr>
                <td>Return</td>
                <td id="cmpLifeProperty">-</td>
                <td id="cmpLifeOffset">-</td>
                <td id="cmpLifeStocks">-</td>
              </tr>
              <tr>
                <td>Annualised</td>
                <td id="cmpLifePropertyAnn">-</td>
                <td id="cmpLifeOffsetAnn">-</td>
                <td id="cmpLifeStocksAnn">-</td>
              </tr>
              <tr class="compare-scenario-start compare-muted">
                <td>Conservative<div class="computed-note" id="cmpLifeConsTip"></div></td>
                <td id="cmpLifePropertyCons">-</td>
                <td id="cmpLifeOffsetCons">-</td>
                <td id="cmpLifeStocksCons">-</td>
              </tr>
              <tr class="compare-muted">
                <td>Annualised</td>
                <td id="cmpLifePropertyConsAnn">-</td>
                <td id="cmpLifeOffsetConsAnn">-</td>
                <td id="cmpLifeStocksConsAnn">-</td>
              </tr>
              <tr class="compare-muted">
                <td>Worst Case<div class="computed-note" id="cmpLifeWorstTip"></div></td>
                <td id="cmpLifePropertyWorst">-</td>
                <td id="cmpLifeOffsetWorst">-</td>
                <td id="cmpLifeStocksWorst">-</td>
              </tr>
              <tr class="compare-muted">
                <td>Annualised</td>
                <td id="cmpLifePropertyWorstAnn">-</td>
                <td id="cmpLifeOffsetWorstAnn">-</td>
                <td id="cmpLifeStocksWorstAnn">-</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Shared state
    window.TrueReturn = {
      totalUpfront: parseFloat(document.getElementById('globalCashInvestment').value) || 60000,
      interestRate: 0,
      loanTerm: 30
    };

    // Tab switching
    function initTabs() {
      const tabs = document.querySelectorAll('.sidebar-tab');
      const sections = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          sections.forEach(s => s.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });
    }
    initTabs();

    // Theme toggle
    function initTheme() {
      const toggle = document.getElementById('themeToggle');
      const html = document.documentElement;
      const saved = localStorage.getItem('truereturn-theme');
      if (saved) html.setAttribute('data-theme', saved);
      toggle.addEventListener('click', () => {
        const next = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        html.setAttribute('data-theme', next);
        localStorage.setItem('truereturn-theme', next);
      });
    }
    initTheme();

    // Solve: cash = price * depositPct + stampDuty(price) + conveyancing
    // Returns the max purchase price affordable with the given cash amount
    function maxPurchasePrice(cash, depositPct, state) {
      if (cash <= 0 || depositPct <= 0) return 0;
      const conveyancing = stateDefaults[state].conveyancing;
      let lo = 0, hi = cash / depositPct; // upper bound: all cash goes to deposit
      for (let i = 0; i < 50; i++) {
        const mid = (lo + hi) / 2;
        const cost = mid * depositPct + calcStampDuty(state, mid) + conveyancing;
        if (cost <= cash) lo = mid;
        else hi = mid;
      }
      return Math.floor(lo);
    }

    // Called when sidebar input or relevant property inputs change
    function syncFromGlobal() {
      const cash = parseFloat(document.getElementById('globalCashInvestment').value) || 0;
      window.TrueReturn.totalUpfront = cash;

      // Property: compute max purchase price from global cash
      if (document.getElementById('useGlobalCashProperty').checked) {
        const depositPct = getVal('depositPct') / 100;
        const state = document.getElementById('state').value;
        const price = maxPurchasePrice(cash, depositPct, state);
        document.getElementById('purchasePrice').value = price;
      }

      // Offset: sync cash amount
      if (document.getElementById('usePropertyUpfront').checked) {
        document.getElementById('offsetAmount').value = Math.round(cash);
      }

      // Stocks: sync cash amount
      if (document.getElementById('usePropertyUpfrontStocks').checked) {
        document.getElementById('stocksAmount').value = Math.round(cash);
      }

      calculate();
      calculateOffset();
      calculateStocks();
    }

    const inputs = document.querySelectorAll('#tab-property input[type="number"]');
    const stateSelect = document.getElementById('state');
    const loanTypeSelect = document.getElementById('loanType');
    const loanTermGroup = document.getElementById('loanTermGroup');

    // Show/hide loan term based on loan type
    loanTypeSelect.addEventListener('change', function() {
      loanTermGroup.style.display = this.value === 'PI' ? '' : 'none';
      calculate();
    });

    function getVal(id) {
      return parseFloat(document.getElementById(id).value) || 0;
    }

    function formatCurrency(amount) {
      const abs = Math.abs(amount);
      const formatted = abs >= 1000
        ? '$' + abs.toLocaleString('en-AU', { minimumFractionDigits: 0, maximumFractionDigits: 0 })
        : '$' + abs.toFixed(0);
      return amount < 0 ? '-' + formatted : formatted;
    }

    // State-based average estimates (annual)
    const stateDefaults = {
      NSW: { conveyancing: 1800, insurance: 1800, council: 2000 },
      VIC: { conveyancing: 1100, insurance: 1500, council: 1900 },
      QLD: { conveyancing: 900,  insurance: 2200, council: 1800 },
      SA:  { conveyancing: 1000, insurance: 1300, council: 1600 },
      WA:  { conveyancing: 1300, insurance: 1500, council: 1800 },
      TAS: { conveyancing: 1000, insurance: 1200, council: 1400 },
      ACT: { conveyancing: 1100, insurance: 1300, council: 2100 },
      NT:  { conveyancing: 1000, insurance: 2500, council: 1700 },
    };

    // Stamp duty calculators by state (general/investor rates, not FHB)
    function calcStampDuty(state, price) {
      if (price <= 0) return 0;

      switch (state) {
        case 'NSW':
          if (price <= 14000) return price * 0.0125;
          if (price <= 31000) return 175 + (price - 14000) * 0.015;
          if (price <= 83000) return 430 + (price - 31000) * 0.0175;
          if (price <= 313000) return 1340 + (price - 83000) * 0.035;
          if (price <= 1043000) return 9390 + (price - 313000) * 0.045;
          if (price <= 3721000) return 42240 + (price - 1043000) * 0.055;
          return price * 0.07;

        case 'VIC':
          if (price <= 25000) return price * 0.014;
          if (price <= 130000) return 350 + (price - 25000) * 0.024;
          if (price <= 960000) return 2870 + (price - 130000) * 0.06;
          if (price <= 2000000) return price * 0.055;
          return 110000 + (price - 2000000) * 0.065;

        case 'QLD':
          if (price <= 5000) return 0;
          if (price <= 75000) return (price - 5000) * 0.015;
          if (price <= 540000) return 1050 + (price - 75000) * 0.035;
          if (price <= 1000000) return 17325 + (price - 540000) * 0.045;
          return 38025 + (price - 1000000) * 0.0575;

        case 'SA':
          if (price <= 12000) return price * 0.01;
          if (price <= 30000) return 120 + (price - 12000) * 0.02;
          if (price <= 50000) return 480 + (price - 30000) * 0.03;
          if (price <= 100000) return 1080 + (price - 50000) * 0.035;
          if (price <= 200000) return 2830 + (price - 100000) * 0.04;
          if (price <= 250000) return 6830 + (price - 200000) * 0.0425;
          if (price <= 300000) return 8955 + (price - 250000) * 0.0475;
          if (price <= 500000) return 11330 + (price - 300000) * 0.05;
          return 21330 + (price - 500000) * 0.055;

        case 'WA':
          if (price <= 120000) return price * 0.019;
          if (price <= 150000) return 2280 + (price - 120000) * 0.0285;
          if (price <= 360000) return 3135 + (price - 150000) * 0.038;
          if (price <= 725000) return 11115 + (price - 360000) * 0.0475;
          return 28453 + (price - 725000) * 0.0515;

        case 'TAS':
          if (price <= 3000) return 50;
          if (price <= 25000) return 50 + (price - 3000) * 0.0175;
          if (price <= 75000) return 435 + (price - 25000) * 0.0225;
          if (price <= 200000) return 1560 + (price - 75000) * 0.035;
          if (price <= 375000) return 5935 + (price - 200000) * 0.04;
          if (price <= 725000) return 12935 + (price - 375000) * 0.0425;
          return 27810 + (price - 725000) * 0.045;

        case 'ACT':
          if (price <= 260000) return price * 0.0049;
          if (price <= 300000) return 1040 + (price - 260000) * 0.022;
          if (price <= 500000) return 1920 + (price - 300000) * 0.034;
          if (price <= 750000) return 8720 + (price - 500000) * 0.0432;
          if (price <= 1000000) return 19520 + (price - 750000) * 0.059;
          if (price <= 1455000) return 34270 + (price - 1000000) * 0.064;
          return price * 0.0454;

        case 'NT':
          if (price <= 525000) {
            const v = price / 1000;
            return (0.06571441 * v * v + 15 * v);
          }
          if (price <= 3000000) return price * 0.0495;
          if (price <= 5000000) return price * 0.0575;
          return price * 0.0595;

        default:
          return 0;
      }
    }

    function calculate() {
      const purchasePrice = getVal('purchasePrice');
      const depositPct = getVal('depositPct') / 100;
      const state = stateSelect.value;
      const defaults = stateDefaults[state];
      const stampDuty = Math.round(calcStampDuty(state, purchasePrice));
      const loanType = loanTypeSelect.value;
      const loanTerm = getVal('loanTerm');
      const interestRate = getVal('interestRate') / 100;
      const weeklyRent = getVal('weeklyRent');
      const managementFeePct = getVal('managementFee') / 100;
      const expectedGrowth = getVal('expectedGrowth') / 100;

      // State-based values
      const conveyancing = defaults.conveyancing;
      const insurance = defaults.insurance;
      const councilFees = defaults.council;

      // Core figures
      const deposit = purchasePrice * depositPct;
      document.getElementById('resDepositAmount').textContent = formatCurrency(deposit);
      const loanAmount = purchasePrice - deposit;

      // Loan payment calculation
      let annualLoanPayment;
      if (loanType === 'IO' || interestRate === 0) {
        annualLoanPayment = loanAmount * interestRate;
      } else {
        // P&I: M = P * [r(1+r)^n] / [(1+r)^n - 1]
        const monthlyRate = interestRate / 12;
        const numPayments = loanTerm * 12;
        const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
        annualLoanPayment = monthlyPayment * 12;
      }

      // Annual income
      const annualRent = weeklyRent * 52;

      // Management fee
      const annualManagementFee = annualRent * managementFeePct;

      // Allowances
      const vacancyAllowance = weeklyRent * 2;
      const maintenanceAllowance = purchasePrice * 0.005;

      // Annual expenses
      const totalExpenses = annualLoanPayment + annualManagementFee + insurance + councilFees + vacancyAllowance + maintenanceAllowance;

      // Cash flow (interest-only basis)
      const annualCashFlow = annualRent - totalExpenses;
      const monthlyCashFlow = annualCashFlow / 12;

      // Yields
      const grossYield = purchasePrice > 0 ? (annualRent / purchasePrice) * 100 : 0;
      const netYield = purchasePrice > 0
        ? ((annualRent - totalExpenses) / purchasePrice) * 100
        : 0;

      // Startup expenses
      const totalUpfront = deposit + stampDuty + conveyancing;

      // Sync rate and term to shared state and other tabs
      window.TrueReturn.interestRate = getVal('interestRate');
      window.TrueReturn.loanTerm = loanTerm;
      if (document.getElementById('usePropertyRate').checked) {
        document.getElementById('offsetInterestRate').value = getVal('interestRate');
      }
      if (document.getElementById('usePropertyTermStocks').checked) {
        document.getElementById('stocksPeriod').value = loanTerm;
      }

      // Update DOM — Start Up Expenses
      document.getElementById('resDeposit').textContent = formatCurrency(deposit);
      document.getElementById('resStampDuty').textContent = formatCurrency(stampDuty);
      document.getElementById('resConveyancing').textContent = formatCurrency(conveyancing);
      document.getElementById('resTotalUpfront').textContent = formatCurrency(totalUpfront);

      // Update DOM — Income
      document.getElementById('resWeeklyRent').textContent = formatCurrency(weeklyRent) + '/wk';
      document.getElementById('resAnnualRent').textContent = formatCurrency(annualRent) + '/yr';

      // Update DOM — Month-to-Month Picture
      const monthlyRent = annualRent / 12;
      const monthlyMgmt = annualManagementFee / 12;
      const monthlyLoan = annualLoanPayment / 12;
      const monthlyNet = monthlyRent - monthlyMgmt - monthlyLoan;
      document.getElementById('resMonthlyRent').textContent = formatCurrency(monthlyRent) + '/mo';
      document.getElementById('resMonthlyMgmt').textContent = '-' + formatCurrency(monthlyMgmt) + '/mo';
      document.getElementById('resMonthlyLoan').textContent = '-' + formatCurrency(monthlyLoan) + '/mo';
      const mCfEl = document.getElementById('resMonthlyCashFlow');
      mCfEl.textContent = formatCurrency(monthlyNet) + '/mo';
      mCfEl.className = 'line-value ' + (monthlyNet >= 0 ? 'positive' : 'negative');

      // Update DOM — Expenses
      document.getElementById('resLoanPayment').textContent = formatCurrency(annualLoanPayment) + '/yr';

      // Loan payment breakdown: interest vs principal (first year)
      const annualInterest = loanAmount * interestRate;
      const annualPrincipal = loanType === 'PI' ? annualLoanPayment - annualInterest : 0;
      document.getElementById('resInterestPortion').textContent = 'Interest: ' + formatCurrency(annualInterest);
      document.getElementById('resPrincipalPortion').textContent = 'Principal: ' + formatCurrency(annualPrincipal);
      document.getElementById('loanBreakdown').style.display = loanType === 'PI' ? 'flex' : 'none';

      document.getElementById('resManagement').textContent = formatCurrency(annualManagementFee) + '/yr';
      document.getElementById('resInsurance').textContent = formatCurrency(insurance) + '/yr';
      document.getElementById('resCouncil').textContent = formatCurrency(councilFees) + '/yr';
      document.getElementById('resVacancy').textContent = formatCurrency(vacancyAllowance) + '/yr';
      document.getElementById('resMaintenance').textContent = formatCurrency(maintenanceAllowance) + '/yr';
      document.getElementById('resTotalExpenses').textContent = formatCurrency(totalExpenses) + '/yr';

      // Tax Benefit
      const annualInterestOnly = loanAmount * interestRate;
      const deductibleExpenses = annualInterestOnly + annualManagementFee + insurance + councilFees + maintenanceAllowance;
      const netRentalPosition = annualRent - deductibleExpenses;
      const taxBenefit = netRentalPosition < 0 ? Math.abs(netRentalPosition) * 0.30 : 0;
      document.getElementById('resDeductible').textContent = formatCurrency(deductibleExpenses) + '/yr';
      const nrEl = document.getElementById('resNetRental');
      nrEl.textContent = formatCurrency(netRentalPosition) + '/yr';
      nrEl.className = 'line-value ' + (netRentalPosition >= 0 ? 'positive' : 'negative');
      const tbEl = document.getElementById('resTaxBenefit');
      tbEl.textContent = taxBenefit > 0 ? formatCurrency(taxBenefit) + '/yr' : '-';
      tbEl.className = 'line-value ' + (taxBenefit > 0 ? 'positive' : '');

      const totalExpensesAfterTax = totalExpenses - taxBenefit;
      document.getElementById('resTotalExpensesAfterTax').textContent = formatCurrency(totalExpensesAfterTax) + '/yr';

      // Update DOM — Results
      const cashFlowEl = document.getElementById('annualCashFlow');
      cashFlowEl.textContent = formatCurrency(annualCashFlow) + '/yr';
      cashFlowEl.className = 'result-value ' + (annualCashFlow >= 0 ? 'positive' : 'negative');
      document.getElementById('monthlyCashFlow').textContent = formatCurrency(monthlyCashFlow) + '/month';

      document.getElementById('grossYield').textContent = grossYield.toFixed(2) + '%';

      const netYieldEl = document.getElementById('netYield');
      netYieldEl.textContent = netYield.toFixed(2) + '%';
      netYieldEl.className = 'result-value ' + (netYield >= 0 ? 'positive' : 'negative');

      // Projections
      document.getElementById('projLifeHeader').textContent = loanTerm + ' Year (Lifetime)';

      [{years: 5, prefix: 'proj5'}, {years: 10, prefix: 'proj10'}, {years: loanTerm, prefix: 'projLife'}].forEach(({years, prefix}) => {
        const futureValue = purchasePrice * Math.pow(1 + expectedGrowth, years);
        const capitalGrowth = futureValue - purchasePrice;

        // Remaining loan balance
        let remainingLoan;
        if (loanType === 'IO') {
          remainingLoan = loanAmount;
        } else if (interestRate === 0) {
          remainingLoan = Math.max(0, loanAmount - (loanAmount / (loanTerm * 12)) * (years * 12));
        } else {
          const monthlyRate = interestRate / 12;
          const totalPayments = loanTerm * 12;
          const paymentsMade = Math.min(years * 12, totalPayments);
          remainingLoan = loanAmount * (Math.pow(1 + monthlyRate, totalPayments) - Math.pow(1 + monthlyRate, paymentsMade)) / (Math.pow(1 + monthlyRate, totalPayments) - 1);
          if (remainingLoan < 0) remainingLoan = 0;
        }

        const equity = futureValue - remainingLoan;

        // Projected rent grows with property value
        const futureWeeklyRent = weeklyRent * Math.pow(1 + expectedGrowth, years);
        const futureAnnualRent = futureWeeklyRent * 52;

        // Projected expenses (maintenance and vacancy scale with growth, loan payment stays fixed)
        const futureManagement = futureAnnualRent * managementFeePct;
        const futureVacancy = futureWeeklyRent * 2;
        const futureMaintenance = futureValue * 0.005;
        const futureExpenses = annualLoanPayment + futureManagement + insurance + councilFees + futureVacancy + futureMaintenance;
        const futureCashFlow = futureAnnualRent - futureExpenses;

        // Update DOM
        document.getElementById(`${prefix}Value`).textContent = formatCurrency(futureValue);
        document.getElementById(`${prefix}Growth`).textContent = formatCurrency(capitalGrowth);
        const principalPaid = loanAmount - remainingLoan;
        document.getElementById(`${prefix}Principal`).textContent = formatCurrency(principalPaid);
        document.getElementById(`${prefix}Loan`).textContent = formatCurrency(remainingLoan);
        document.getElementById(`${prefix}Equity`).textContent = formatCurrency(equity);
        const usableEquity = equity * 0.8;
        document.getElementById(`${prefix}UsableEquity`).textContent = formatCurrency(usableEquity);
        document.getElementById(`${prefix}Rent`).textContent = formatCurrency(futureWeeklyRent) + '/wk';

        const cfEl = document.getElementById(`${prefix}CashFlow`);
        cfEl.textContent = formatCurrency(futureCashFlow) + '/yr';
        cfEl.className = 'line-value ' + (futureCashFlow >= 0 ? 'positive' : 'negative');

        // Cash Out Position
        const salePrice = futureValue;
        const salesCosts = salePrice * 0.03;
        const netProceeds = salePrice - salesCosts - remainingLoan;
        const costBase = purchasePrice + stampDuty + conveyancing + salesCosts;
        const capitalGain = salePrice - costBase;
        const discountedGain = capitalGain > 0 ? capitalGain * 0.50 : 0;
        const cgt = discountedGain * 0.30;
        const trueCashReturn = netProceeds - cgt;

        document.getElementById(`${prefix}Sale`).textContent = formatCurrency(salePrice);
        document.getElementById(`${prefix}SaleCosts`).textContent = formatCurrency(salesCosts);
        document.getElementById(`${prefix}LoanPayout`).textContent = formatCurrency(remainingLoan);
        document.getElementById(`${prefix}NetProceeds`).textContent = formatCurrency(netProceeds);
        document.getElementById(`${prefix}CGT`).textContent = '\u2248 ' + formatCurrency(cgt);

        const trEl = document.getElementById(`${prefix}TrueReturn`);
        trEl.textContent = formatCurrency(trueCashReturn);
        trEl.className = 'line-value ' + (trueCashReturn >= 0 ? 'positive' : 'negative');

        // Investment Performance
        let cumulativeCashFlow = 0;
        for (let y = 1; y <= years; y++) {
          const yRent = weeklyRent * Math.pow(1 + expectedGrowth, y) * 52;
          const yValue = purchasePrice * Math.pow(1 + expectedGrowth, y);
          const yMgmt = yRent * managementFeePct;
          const yVacancy = (weeklyRent * Math.pow(1 + expectedGrowth, y)) * 2;
          const yMaint = yValue * 0.005;
          const yExpenses = annualLoanPayment + yMgmt + insurance + councilFees + yVacancy + yMaint;
          cumulativeCashFlow += yRent - yExpenses;
        }

        const totalProfit = (trueCashReturn - totalUpfront) + cumulativeCashFlow;
        const returnOnCash = totalUpfront > 0 ? (totalProfit / totalUpfront) * 100 : 0;
        const annualisedReturn = totalUpfront > 0 ? (Math.pow(1 + totalProfit / totalUpfront, 1 / years) - 1) * 100 : 0;

        document.getElementById(`${prefix}CashInvested`).textContent = formatCurrency(totalUpfront);

        const cumCfEl = document.getElementById(`${prefix}CumCashFlow`);
        cumCfEl.textContent = formatCurrency(cumulativeCashFlow);

        const tpEl = document.getElementById(`${prefix}TotalProfit`);
        tpEl.textContent = formatCurrency(totalProfit);
        tpEl.className = 'line-value ' + (totalProfit >= 0 ? 'positive' : 'negative');

        const rocEl = document.getElementById(`${prefix}ReturnOnCash`);
        rocEl.textContent = returnOnCash.toFixed(2) + '%';
        rocEl.className = 'line-value ' + (returnOnCash >= 0 ? 'positive' : 'negative');

        const arEl = document.getElementById(`${prefix}AnnualisedReturn`);
        arEl.textContent = annualisedReturn.toFixed(2) + '%';
        arEl.className = 'line-value ' + (annualisedReturn >= 0 ? 'positive' : 'negative');
      });

      calculateOffset();
      calculateStocks();
      updateCompare();
    }

    inputs.forEach(input => input.addEventListener('input', function() {
      // When deposit% or state changes and the property toggle is on, recalc from global cash
      if (document.getElementById('useGlobalCashProperty').checked &&
          (this.id === 'depositPct')) {
        syncFromGlobal();
      } else {
        calculate();
      }
    }));
    stateSelect.addEventListener('change', function() {
      if (document.getElementById('useGlobalCashProperty').checked) {
        syncFromGlobal();
      } else {
        calculate();
      }
    });

    // Sidebar global cash input
    document.getElementById('globalCashInvestment').addEventListener('input', syncFromGlobal);

    // Property toggle: Use Total Cash Investment
    document.getElementById('useGlobalCashProperty').addEventListener('change', function() {
      const priceInput = document.getElementById('purchasePrice');
      priceInput.disabled = this.checked;
      if (this.checked) {
        syncFromGlobal();
      } else {
        calculate();
      }
    });

    // --- Offset Calculator ---

    const offsetLoanTypeSelect = document.getElementById('offsetLoanType');
    const offsetLoanTermGroup = document.getElementById('offsetLoanTermGroup');
    const usePropertyUpfront = document.getElementById('usePropertyUpfront');
    const usePropertyRate = document.getElementById('usePropertyRate');
    const offsetAmountInput = document.getElementById('offsetAmount');
    const offsetRateInput = document.getElementById('offsetInterestRate');

    // Show/hide offset loan term based on loan type
    offsetLoanTypeSelect.addEventListener('change', function() {
      offsetLoanTermGroup.style.display = this.value === 'PI' ? '' : 'none';
      calculateOffset();
    });

    // Toggle: Use Property Total Upfront
    usePropertyUpfront.addEventListener('change', function() {
      offsetAmountInput.disabled = this.checked;
      if (this.checked) {
        offsetAmountInput.value = Math.round(window.TrueReturn.totalUpfront);
      }
      calculateOffset();
    });

    // Toggle: Use Property Rate
    usePropertyRate.addEventListener('change', function() {
      offsetRateInput.disabled = this.checked;
      if (this.checked) {
        offsetRateInput.value = window.TrueReturn.interestRate;
      }
      calculateOffset();
    });

    // Wire offset inputs
    document.querySelectorAll('#tab-offset input[type="number"], #tab-offset select').forEach(el => {
      el.addEventListener('input', calculateOffset);
      el.addEventListener('change', calculateOffset);
    });

    function calculateOffset() {
      const offsetAmount = parseFloat(offsetAmountInput.value) || 0;
      const loanBalance = parseFloat(document.getElementById('offsetLoanBalance').value) || 0;
      const rate = (parseFloat(offsetRateInput.value) || 0) / 100;
      const loanType = offsetLoanTypeSelect.value;
      const loanTerm = parseFloat(document.getElementById('offsetLoanTerm').value) || 30;
      document.getElementById('offsetLifeHeader').textContent = loanTerm + ' Year (Lifetime)';

      // Cap offset at loan balance
      const effectiveOffset = Math.min(offsetAmount, loanBalance);

      let noOffset5 = 0, noOffset10 = 0, withOffset5 = 0, withOffset10 = 0;
      let totalInterestNoOffset = 0, totalInterestWithOffset = 0;
      let monthsNoOffset = 0, monthsWithOffset = 0;
      const isPandI = loanType === 'PI' && rate > 0;

      if (!isPandI) {
        // Interest-only: simple calculation (loan never pays off)
        noOffset5 = loanBalance * rate * 5;
        noOffset10 = loanBalance * rate * 10;
        withOffset5 = (loanBalance - effectiveOffset) * rate * 5;
        withOffset10 = (loanBalance - effectiveOffset) * rate * 10;
        totalInterestNoOffset = loanBalance * rate * loanTerm;
        totalInterestWithOffset = (loanBalance - effectiveOffset) * rate * loanTerm;
        monthsNoOffset = 0;
        monthsWithOffset = 0;
      } else {
        // P&I: month-by-month amortisation over full loan term
        const monthlyRate = rate / 12;
        const numPayments = loanTerm * 12;

        if (monthlyRate > 0 && numPayments > 0) {
          const monthlyPayment = loanBalance * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);

          // Without offset — full term
          let balance = loanBalance;
          for (let m = 1; m <= numPayments && balance > 0.01; m++) {
            const interest = balance * monthlyRate;
            const principal = Math.min(monthlyPayment - interest, balance);
            if (m <= 60) noOffset5 += interest;
            if (m <= 120) noOffset10 += interest;
            totalInterestNoOffset += interest;
            balance -= principal;
            monthsNoOffset = m;
          }

          // With offset — full term
          let balanceWithOffset = loanBalance;
          for (let m = 1; m <= numPayments && balanceWithOffset > 0.01; m++) {
            const effectiveBal = Math.max(0, balanceWithOffset - effectiveOffset);
            const interest = effectiveBal * monthlyRate;
            const principal = Math.min(monthlyPayment - interest, balanceWithOffset);
            if (m <= 60) withOffset5 += interest;
            if (m <= 120) withOffset10 += interest;
            totalInterestWithOffset += interest;
            balanceWithOffset -= principal;
            monthsWithOffset = m;
          }
        }
      }

      const saved5 = noOffset5 - withOffset5;
      const saved10 = noOffset10 - withOffset10;
      const savedLifetime = totalInterestNoOffset - totalInterestWithOffset;

      // Effective return = the interest rate (each dollar in offset saves you the rate, tax-free)
      const effectiveReturnPct = effectiveOffset > 0 ? rate * 100 : 0;

      // Time saved (P&I only)
      const timeSavedRow = document.getElementById('offsetTimeSavedRow');
      if (isPandI && monthsNoOffset > monthsWithOffset) {
        const savedMonths = monthsNoOffset - monthsWithOffset;
        const yrs = Math.floor(savedMonths / 12);
        const mos = savedMonths % 12;
        let timeStr = '';
        if (yrs > 0) timeStr += yrs + (yrs === 1 ? ' yr' : ' yrs');
        if (yrs > 0 && mos > 0) timeStr += ' ';
        if (mos > 0) timeStr += mos + (mos === 1 ? ' mo' : ' mos');
        if (!timeStr) timeStr = '-';
        document.getElementById('offsetTimeSaved').textContent = timeStr;
        timeSavedRow.style.display = '';
      } else {
        timeSavedRow.style.display = isPandI ? '' : 'none';
        document.getElementById('offsetTimeSaved').textContent = '-';
      }

      // Effective return (shown once)
      document.getElementById('offsetEffectiveReturn').textContent = effectiveReturnPct.toFixed(2) + '%';

      // 5 Year
      document.getElementById('offsetNoOffset5').textContent = formatCurrency(noOffset5);
      document.getElementById('offsetWithOffset5').textContent = formatCurrency(withOffset5);
      document.getElementById('offsetSaved5').textContent = formatCurrency(saved5);

      // 10 Year
      document.getElementById('offsetNoOffset10').textContent = formatCurrency(noOffset10);
      document.getElementById('offsetWithOffset10').textContent = formatCurrency(withOffset10);
      document.getElementById('offsetSaved10').textContent = formatCurrency(saved10);

      // Lifetime
      document.getElementById('offsetNoOffsetLife').textContent = formatCurrency(totalInterestNoOffset);
      document.getElementById('offsetWithOffsetLife').textContent = formatCurrency(totalInterestWithOffset);
      document.getElementById('offsetSavedLifetime').textContent = formatCurrency(savedLifetime);

      updateCompare();
    }

    // Set initial disabled state for synced inputs
    offsetAmountInput.disabled = usePropertyUpfront.checked;
    offsetRateInput.disabled = usePropertyRate.checked;

    // --- Stocks / ETF Calculator ---

    const stocksTypePresets = {
      ASX200:     { growth: 7,  dividend: 4   },
      SP500:      { growth: 10, dividend: 1.5 },
      HighGrowth: { growth: 12, dividend: 0.5 },
    };

    const stocksTypeDescriptions = {
      ASX200: 'Based on the S&P/ASX 200 index, representing the 200 largest companies on the Australian Securities Exchange. Historical average ~7% growth with ~4% dividend yield. Past performance does not guarantee future results.',
      SP500: 'Based on the S&P 500 index, representing 500 large-cap US companies. Historical average ~10% growth with ~1.5% dividend yield. Returns are in USD and do not account for currency conversion or hedging costs. Past performance does not guarantee future results.',
      HighGrowth: 'Based on high-growth equity ETFs focused on technology and emerging sectors. These funds carry higher volatility and risk of significant drawdowns. Past performance does not guarantee future results.',
      Custom: 'Enter your own growth and dividend assumptions. Ensure your estimates are realistic — most diversified portfolios return 6–10% p.a. over the long term.',
    };

    const stocksTypeSelect = document.getElementById('stocksType');
    const stocksGrowthInput = document.getElementById('stocksGrowth');
    const stocksDividendInput = document.getElementById('stocksDividend');
    const stocksAmountInput = document.getElementById('stocksAmount');
    const stocksPeriodInput = document.getElementById('stocksPeriod');
    const usePropertyUpfrontStocks = document.getElementById('usePropertyUpfrontStocks');
    const usePropertyTermStocks = document.getElementById('usePropertyTermStocks');

    const stocksTypeNote = document.getElementById('stocksTypeNote');

    function updateStocksType() {
      const type = stocksTypeSelect.value;
      const isCustom = type === 'Custom';
      stocksGrowthInput.disabled = !isCustom;
      stocksDividendInput.disabled = !isCustom;
      if (!isCustom) {
        const preset = stocksTypePresets[type];
        stocksGrowthInput.value = preset.growth;
        stocksDividendInput.value = preset.dividend;
      }
      stocksTypeNote.textContent = stocksTypeDescriptions[type];
      calculateStocks();
    }

    // Investment type change — populate presets, disable/enable manual entry
    stocksTypeSelect.addEventListener('change', updateStocksType);

    // Toggle: Use Property Total Upfront for stocks
    usePropertyUpfrontStocks.addEventListener('change', function() {
      stocksAmountInput.disabled = this.checked;
      if (this.checked) {
        stocksAmountInput.value = Math.round(window.TrueReturn.totalUpfront);
      }
      calculateStocks();
    });

    // Toggle: Use Property Loan Term for stocks
    usePropertyTermStocks.addEventListener('change', function() {
      stocksPeriodInput.disabled = this.checked;
      if (this.checked) {
        stocksPeriodInput.value = window.TrueReturn.loanTerm;
      }
      calculateStocks();
    });

    // Wire all stocks inputs
    document.querySelectorAll('#tab-stocks input[type="number"], #tab-stocks select, #tab-stocks input[type="checkbox"]').forEach(el => {
      el.addEventListener('input', calculateStocks);
      el.addEventListener('change', calculateStocks);
    });

    function calculateStocks() {
      const investment = parseFloat(stocksAmountInput.value) || 0;
      const growthRate = (parseFloat(stocksGrowthInput.value) || 0) / 100;
      const dividendYield = (parseFloat(stocksDividendInput.value) || 0) / 100;
      const reinvest = document.getElementById('stocksReinvest').checked;
      const period = parseInt(stocksPeriodInput.value) || 30;
      document.getElementById('stocksLifeHeader').textContent = period + ' Year (Lifetime)';

      // Total return p.a.
      const totalReturnPA = (growthRate + dividendYield) * 100;
      document.getElementById('stocksTotalReturnPA').textContent = totalReturnPA.toFixed(2) + '%';

      const horizons = [
        { years: 5,      prefix: 'stocks5' },
        { years: 10,     prefix: 'stocks10' },
        { years: period,  prefix: 'stocksLife' },
      ];

      horizons.forEach(({ years, prefix }) => {
        let value = investment;
        let cumulativeDividends = 0;

        for (let y = 1; y <= years; y++) {
          const yearDiv = value * dividendYield;
          cumulativeDividends += yearDiv;
          value *= (1 + growthRate);
          if (reinvest) {
            value += yearDiv;
          }
        }

        const portfolioValue = value;
        const capitalGrowth = value - investment;
        const dividendsEarned = cumulativeDividends;
        const totalValue = reinvest ? value : value + cumulativeDividends;
        const totalReturn = totalValue - investment;

        document.getElementById(prefix + 'Portfolio').textContent = formatCurrency(portfolioValue);
        document.getElementById(prefix + 'Growth').textContent = formatCurrency(capitalGrowth);
        document.getElementById(prefix + 'Dividends').textContent = formatCurrency(dividendsEarned);
        document.getElementById(prefix + 'TotalValue').textContent = formatCurrency(totalValue);

        const retEl = document.getElementById(prefix + 'Return');
        retEl.textContent = formatCurrency(totalReturn);
        retEl.className = 'line-value ' + (totalReturn >= 0 ? 'positive' : 'negative');
      });

      // Conservative & Worst case for stocks display
      const stkTypeVal = stocksTypeSelect.value;

      const consPreset = stocksConsPresets[stkTypeVal];
      const worstPreset = stocksWorstPresets[stkTypeVal];

      function calcScenarioReturn(gRate, dRate, yrs) {
        let v = investment;
        let cd = 0;
        for (let yr = 1; yr <= yrs; yr++) {
          v *= (1 + gRate);
          const yd = v * dRate;
          cd += yd;
          if (reinvest) v += yd;
        }
        return (reinvest ? v : v + cd) - investment;
      }

      let consGr, consDy, worstGr, worstDy;
      if (stkTypeVal === 'Custom') {
        consGr = growthRate / 2;
        consDy = dividendYield / 2;
        worstGr = -0.05;
        worstDy = 0;
      } else {
        consGr = consPreset.growth / 100;
        consDy = consPreset.dividend / 100;
        worstGr = worstPreset.growth / 100;
        worstDy = worstPreset.dividend / 100;
      }

      horizons.forEach(({ years, prefix }) => {
        const consRet = calcScenarioReturn(consGr, consDy, years);
        const worstRet = calcScenarioReturn(worstGr, worstDy, years);
        const consEl = document.getElementById(prefix + 'ConsReturn');
        consEl.textContent = formatCurrency(consRet);
        consEl.className = 'line-value ' + (consRet >= 0 ? 'positive' : 'negative');
        const worstEl = document.getElementById(prefix + 'WorstReturn');
        worstEl.textContent = formatCurrency(worstRet);
        worstEl.className = 'line-value ' + (worstRet >= 0 ? 'positive' : 'negative');
      });

      updateCompare();
    }

    // Set initial disabled state for stocks synced inputs
    stocksAmountInput.disabled = usePropertyUpfrontStocks.checked;
    stocksPeriodInput.disabled = usePropertyTermStocks.checked;
    stocksTypeNote.textContent = stocksTypeDescriptions[stocksTypeSelect.value];

    // --- Compare Table ---

    document.getElementById('cmpDetailsToggle').addEventListener('click', function() {
      const row = document.getElementById('cmpDetailsRow');
      const visible = row.style.display !== 'none';
      row.style.display = visible ? 'none' : '';
      this.textContent = visible ? '\u2212 Assumptions' : '+ Assumptions';
    });

    // --- Worst Case Helpers ---

    function calcPropertyTotalProfit(years, worstGrowth) {
      const purchasePrice = getVal('purchasePrice');
      const depositPct = getVal('depositPct') / 100;
      const state = document.getElementById('state').value;
      const defaults = stateDefaults[state];
      const stampDuty = Math.round(calcStampDuty(state, purchasePrice));
      const lType = document.getElementById('loanType').value;
      const lTermYrs = getVal('loanTerm');
      const iRate = getVal('interestRate') / 100;
      const wRent = getVal('weeklyRent');
      const mgmtPct = getVal('managementFee') / 100;
      const deposit = purchasePrice * depositPct;
      const loan = purchasePrice - deposit;
      const conv = defaults.conveyancing;
      const ins = defaults.insurance;
      const council = defaults.council;
      const upfront = deposit + stampDuty + conv;

      let annLoan;
      if (lType === 'IO' || iRate === 0) {
        annLoan = loan * iRate;
      } else {
        const mr = iRate / 12;
        const np = lTermYrs * 12;
        annLoan = loan * (mr * Math.pow(1 + mr, np)) / (Math.pow(1 + mr, np) - 1) * 12;
      }

      const fv = purchasePrice * Math.pow(1 + worstGrowth, years);
      let remLoan;
      if (lType === 'IO') {
        remLoan = loan;
      } else if (iRate === 0) {
        remLoan = Math.max(0, loan - (loan / (lTermYrs * 12)) * (years * 12));
      } else {
        const mr = iRate / 12;
        const tp = lTermYrs * 12;
        const pm = Math.min(years * 12, tp);
        remLoan = loan * (Math.pow(1 + mr, tp) - Math.pow(1 + mr, pm)) / (Math.pow(1 + mr, tp) - 1);
        if (remLoan < 0) remLoan = 0;
      }

      const saleCosts = fv * 0.03;
      const netProceeds = fv - saleCosts - remLoan;
      const costBase = purchasePrice + stampDuty + conv + saleCosts;
      const capGain = fv - costBase;
      const cgt = capGain > 0 ? capGain * 0.50 * 0.30 : 0;
      const trueCash = netProceeds - cgt;

      let cumCF = 0;
      for (let y = 1; y <= years; y++) {
        const yRent = wRent * Math.pow(1 + worstGrowth, y) * 52;
        const yVal = purchasePrice * Math.pow(1 + worstGrowth, y);
        const yExp = annLoan + (yRent * mgmtPct) + ins + council + (wRent * Math.pow(1 + worstGrowth, y) * 2) + (yVal * 0.005);
        cumCF += yRent - yExp;
      }

      return (trueCash - upfront) + cumCF;
    }

    const stocksWorstPresets = {
      ASX200:     { growth: -3,  dividend: 2    },
      SP500:      { growth: -7,  dividend: 0.75 },
      HighGrowth: { growth: -10, dividend: 0.25 },
      Custom:     { growth: -5,  dividend: 0    },
    };

    function calcStocksWorstCase(years) {
      const investment = parseFloat(stocksAmountInput.value) || 0;
      const type = stocksTypeSelect.value;
      const worst = stocksWorstPresets[type];
      const gr = worst.growth / 100;
      const dy = worst.dividend / 100;
      const reinvest = document.getElementById('stocksReinvest').checked;

      let value = investment;
      let cumDiv = 0;
      for (let y = 1; y <= years; y++) {
        const yd = value * dy;
        cumDiv += yd;
        value *= (1 + gr);
        if (reinvest) value += yd;
      }
      const totalValue = reinvest ? value : value + cumDiv;
      return totalValue - investment;
    }

    const stocksConsPresets = {
      ASX200:     { growth: 3, dividend: 3   },
      SP500:      { growth: 4, dividend: 1   },
      HighGrowth: { growth: 5, dividend: 0.3 },
    };

    function calcStocksConsCase(years) {
      const investment = parseFloat(stocksAmountInput.value) || 0;
      const type = stocksTypeSelect.value;
      let gr, dy;
      if (type === 'Custom') {
        gr = ((parseFloat(stocksGrowthInput.value) || 0) / 2) / 100;
        dy = ((parseFloat(stocksDividendInput.value) || 0) / 2) / 100;
      } else {
        const cons = stocksConsPresets[type];
        gr = cons.growth / 100;
        dy = cons.dividend / 100;
      }
      const reinvest = document.getElementById('stocksReinvest').checked;

      let value = investment;
      let cumDiv = 0;
      for (let y = 1; y <= years; y++) {
        const yd = value * dy;
        cumDiv += yd;
        value *= (1 + gr);
        if (reinvest) value += yd;
      }
      const totalValue = reinvest ? value : value + cumDiv;
      return totalValue - investment;
    }

    function updateCompare() {
      const loanTermVal = window.TrueReturn.loanTerm || 30;
      document.getElementById('cmpLifeHeader').textContent = loanTermVal + ' Year (Lifetime)';

      // Mismatch warning — compare all tabs against global cash investment
      const globalCash = Math.round(window.TrueReturn.totalUpfront);
      const propUpfrontCalc = Math.round(getVal('purchasePrice') * getVal('depositPct') / 100 + calcStampDuty(document.getElementById('state').value, getVal('purchasePrice')) + stateDefaults[document.getElementById('state').value].conveyancing);
      const offAmount = Math.round(parseFloat(document.getElementById('offsetAmount').value) || 0);
      const stkAmount = Math.round(parseFloat(document.getElementById('stocksAmount').value) || 0);
      const mismatches = [];
      if (propUpfrontCalc !== globalCash) mismatches.push('Property (' + formatCurrency(propUpfrontCalc) + ')');
      if (offAmount !== globalCash) mismatches.push('Offset (' + formatCurrency(offAmount) + ')');
      if (stkAmount !== globalCash) mismatches.push('Stocks / ETFs (' + formatCurrency(stkAmount) + ')');
      const warningEl = document.getElementById('cmpMismatchWarning');
      if (mismatches.length > 0) {
        document.getElementById('cmpMismatchText').textContent =
          mismatches.join(' and ') + ' using a different amount to Total Cash Investment (' + formatCurrency(globalCash) + '). This comparison is not like-for-like.';
        warningEl.style.display = 'block';
      } else {
        warningEl.style.display = '';
      }

      // Details: Property
      const propPrice = formatCurrency(getVal('purchasePrice'));
      const propDeposit = getVal('depositPct');
      const propLoanType = document.getElementById('loanType').value === 'PI' ? 'P&I' : 'Interest Only';
      const propRate = getVal('interestRate');
      const propGrowth = getVal('expectedGrowth');
      const propRent = formatCurrency(getVal('weeklyRent'));
      document.getElementById('cmpDetailsProperty').innerHTML =
        `<span><strong>${propPrice}</strong> purchase</span>` +
        `<span><strong>${propDeposit}%</strong> deposit · <strong>${propLoanType}</strong></span>` +
        `<span><strong>${propRate}%</strong> interest · <strong>${loanTermVal} yr</strong> term</span>` +
        `<span><strong>${propGrowth}%</strong> annual growth</span>` +
        `<span><strong>${propRent}</strong>/wk rent</span>`;

      // Details: Offset
      const offAmountFmt = formatCurrency(parseFloat(document.getElementById('offsetAmount').value) || 0);
      const offBalance = formatCurrency(parseFloat(document.getElementById('offsetLoanBalance').value) || 0);
      const offRate = parseFloat(document.getElementById('offsetInterestRate').value) || 0;
      const offLoanType = document.getElementById('offsetLoanType').value === 'PI' ? 'P&I' : 'Interest Only';
      const offTerm = parseFloat(document.getElementById('offsetLoanTerm').value) || 30;
      document.getElementById('cmpDetailsOffset').innerHTML =
        `<span><strong>${offAmountFmt}</strong> in offset</span>` +
        `<span><strong>${offBalance}</strong> loan balance</span>` +
        `<span><strong>${offRate}%</strong> interest · <strong>${offLoanType}</strong></span>` +
        `<span><strong>${offTerm} yr</strong> loan term</span>`;

      // Details: Stocks
      const stkAmountFmt = formatCurrency(parseFloat(document.getElementById('stocksAmount').value) || 0);
      const stkType = document.getElementById('stocksType').options[document.getElementById('stocksType').selectedIndex].text;
      const stkGrowth = parseFloat(document.getElementById('stocksGrowth').value) || 0;
      const stkDiv = parseFloat(document.getElementById('stocksDividend').value) || 0;
      const stkReinvest = document.getElementById('stocksReinvest').checked ? 'Yes' : 'No';
      const stkPeriod = parseInt(document.getElementById('stocksPeriod').value) || 30;
      document.getElementById('cmpDetailsStocks').innerHTML =
        `<span><strong>${stkAmountFmt}</strong> invested</span>` +
        `<span><strong>${stkType}</strong></span>` +
        `<span><strong>${stkGrowth}%</strong> growth · <strong>${stkDiv}%</strong> dividend</span>` +
        `<span>Reinvest: <strong>${stkReinvest}</strong> · <strong>${stkPeriod} yr</strong></span>`;

      // Property: Total Profit + Annualised Return
      document.getElementById('cmp5Property').textContent = document.getElementById('proj5TotalProfit').textContent;
      document.getElementById('cmp10Property').textContent = document.getElementById('proj10TotalProfit').textContent;
      document.getElementById('cmpLifeProperty').textContent = document.getElementById('projLifeTotalProfit').textContent;
      document.getElementById('cmp5PropertyAnn').textContent = document.getElementById('proj5AnnualisedReturn').textContent;
      document.getElementById('cmp10PropertyAnn').textContent = document.getElementById('proj10AnnualisedReturn').textContent;
      document.getElementById('cmpLifePropertyAnn').textContent = document.getElementById('projLifeAnnualisedReturn').textContent;

      // Offset: Interest Saved + annualised equivalent
      const offsetAmount = parseFloat(document.getElementById('offsetAmount').value) || 0;
      const saved5 = document.getElementById('offsetSaved5').textContent;
      const saved10 = document.getElementById('offsetSaved10').textContent;
      const savedLife = document.getElementById('offsetSavedLifetime').textContent;
      document.getElementById('cmp5Offset').textContent = saved5;
      document.getElementById('cmp10Offset').textContent = saved10;
      document.getElementById('cmpLifeOffset').textContent = savedLife;

      // Offset annualised: effective return = the interest rate (tax-free)
      const offsetAnn = document.getElementById('offsetEffectiveReturn').textContent;
      document.getElementById('cmp5OffsetAnn').textContent = offsetAnn;
      document.getElementById('cmp10OffsetAnn').textContent = offsetAnn;
      document.getElementById('cmpLifeOffsetAnn').textContent = offsetAnn;

      // Stocks: Total Return + annualised
      const stocksInvestment = parseFloat(document.getElementById('stocksAmount').value) || 0;
      function readCurrency(id) {
        const txt = document.getElementById(id).textContent;
        const negative = txt.startsWith('-$');
        const num = parseFloat(txt.replace(/[^0-9.]/g, ''));
        return isNaN(num) ? 0 : (negative ? -num : num);
      }

      document.getElementById('cmp5Stocks').textContent = document.getElementById('stocks5Return').textContent;
      document.getElementById('cmp10Stocks').textContent = document.getElementById('stocks10Return').textContent;
      document.getElementById('cmpLifeStocks').textContent = document.getElementById('stocksLifeReturn').textContent;

      function stocksAnn(returnId, years) {
        if (stocksInvestment <= 0 || years <= 0) return '-';
        const totalReturn = readCurrency(returnId);
        const totalValue = stocksInvestment + totalReturn;
        const ann = (Math.pow(totalValue / stocksInvestment, 1 / years) - 1) * 100;
        return ann.toFixed(2) + '%';
      }
      document.getElementById('cmp5StocksAnn').textContent = stocksAnn('stocks5Return', 5);
      document.getElementById('cmp10StocksAnn').textContent = stocksAnn('stocks10Return', 10);
      document.getElementById('cmpLifeStocksAnn').textContent = stocksAnn('stocksLifeReturn', loanTermVal);

      // --- Scenario helpers ---
      function setScenarioCell(id, value) {
        const el = document.getElementById(id);
        const cls = value < 0 ? 'negative' : value > 0 ? 'positive' : '';
        el.innerHTML = `<span class="${cls}">${formatCurrency(value)}</span>`;
      }

      function setScenarioCellNA(id) {
        const el = document.getElementById(id);
        el.innerHTML = `<span class="text-muted">N/A</span>`;
      }

      const offsetScenarioTip = 'Offset returns are fixed at the loan rate regardless of market conditions.';
      const selectedType = stocksTypeSelect.value;
      const selectedTypeName = stocksTypeSelect.options[stocksTypeSelect.selectedIndex].text;
      const propUpfront = window.TrueReturn.totalUpfront;

      function scenarioPropertyAnn(profit, years) {
        if (propUpfront <= 0 || years <= 0) return '-';
        return (Math.pow(1 + profit / propUpfront, 1 / years) - 1) * 100;
      }

      function scenarioStocksAnn(returnVal, years) {
        const inv = parseFloat(stocksAmountInput.value) || 0;
        if (inv <= 0 || years <= 0) return '-';
        return (Math.pow((inv + returnVal) / inv, 1 / years) - 1) * 100;
      }

      function setAnnCell(id, annVal) {
        const el = document.getElementById(id);
        if (annVal === '-') { el.textContent = '-'; el.className = ''; return; }
        el.textContent = annVal.toFixed(2) + '%';
        el.className = annVal < 0 ? 'negative' : annVal > 0 ? 'positive' : '';
      }

      // --- Conservative Case ---
      const propConsTip = 'Assumes 2% p.a. property growth (below long-term average). All other inputs unchanged.';
      const stkCons = stocksConsPresets[selectedType];
      const stkConsTip = selectedType === 'Custom'
        ? `Assumes half your entered growth (${((parseFloat(stocksGrowthInput.value) || 0) / 2).toFixed(1)}%) and half dividend (${((parseFloat(stocksDividendInput.value) || 0) / 2).toFixed(1)}%) as a conservative estimate.`
        : `Assumes ${stkCons.growth}% growth, ${stkCons.dividend}% dividend — below-average returns for ${selectedTypeName}.`;

      [{ p: 'cmp5', y: 5 }, { p: 'cmp10', y: 10 }, { p: 'cmpLife', y: loanTermVal }].forEach(({ p, y }) => {
        const propConsProfit = calcPropertyTotalProfit(y, 0.02);
        const stkConsReturn = calcStocksConsCase(y);
        setScenarioCell(p + 'PropertyCons', propConsProfit);
        setScenarioCellNA(p + 'OffsetCons');
        setScenarioCell(p + 'StocksCons', stkConsReturn);
        setAnnCell(p + 'PropertyConsAnn', scenarioPropertyAnn(propConsProfit, y));
        document.getElementById(p + 'OffsetConsAnn').textContent = offsetAnn;
        setAnnCell(p + 'StocksConsAnn', scenarioStocksAnn(stkConsReturn, y));
      });

      const consDescription = 'Property: 2% p.a. growth. Stocks: ' + (selectedType === 'Custom' ? 'half entered values.' : stkCons.growth + '% growth, ' + stkCons.dividend + '% dividend.');
      ['cmp5', 'cmp10', 'cmpLife'].forEach(p => {
        document.getElementById(p + 'ConsTip').textContent = consDescription;
      });

      // --- Worst Case ---
      const propWorstTip = 'Assumes property declines 2% p.a. All other inputs unchanged.';
      const stkWorst = stocksWorstPresets[selectedType];
      const stkWorstTip = selectedType === 'Custom'
        ? 'Assumes -5% growth, 0% dividend as a worst-case stress test.'
        : `Assumes ${stkWorst.growth}% growth, ${stkWorst.dividend}% dividend based on worst historical rolling returns for ${selectedTypeName}.`;

      [{ p: 'cmp5', y: 5 }, { p: 'cmp10', y: 10 }, { p: 'cmpLife', y: loanTermVal }].forEach(({ p, y }) => {
        const propWorstProfit = calcPropertyTotalProfit(y, -0.02);
        const stkWorstReturn = calcStocksWorstCase(y);
        setScenarioCell(p + 'PropertyWorst', propWorstProfit);
        setScenarioCellNA(p + 'OffsetWorst');
        setScenarioCell(p + 'StocksWorst', stkWorstReturn);
        setAnnCell(p + 'PropertyWorstAnn', scenarioPropertyAnn(propWorstProfit, y));
        document.getElementById(p + 'OffsetWorstAnn').textContent = offsetAnn;
        setAnnCell(p + 'StocksWorstAnn', scenarioStocksAnn(stkWorstReturn, y));
      });

      const worstDescription = 'Property: -2% p.a. decline. Stocks: ' + (selectedType === 'Custom' ? '-5% growth, 0% dividend.' : stkWorst.growth + '% growth, ' + stkWorst.dividend + '% dividend.');
      ['cmp5', 'cmp10', 'cmpLife'].forEach(p => {
        document.getElementById(p + 'WorstTip').textContent = worstDescription;
      });

      // Color the return cells
      ['cmp5Property', 'cmp10Property', 'cmpLifeProperty',
       'cmp5Offset', 'cmp10Offset', 'cmpLifeOffset',
       'cmp5Stocks', 'cmp10Stocks', 'cmpLifeStocks'].forEach(id => {
        const el = document.getElementById(id);
        const txt = el.textContent;
        el.classList.remove('positive', 'negative');
        if (txt.startsWith('-$')) {
          el.classList.add('negative');
        } else if (txt !== '-') {
          el.classList.add('positive');
        }
      });
    }

    // Set initial disabled states for toggled inputs
    document.getElementById('purchasePrice').disabled = document.getElementById('useGlobalCashProperty').checked;
    offsetAmountInput.disabled = usePropertyUpfront.checked;
    offsetRateInput.disabled = usePropertyRate.checked;
    stocksAmountInput.disabled = usePropertyUpfrontStocks.checked;
    stocksPeriodInput.disabled = usePropertyTermStocks.checked;

    // Run initial calculations — syncFromGlobal sets purchase price from global cash, then calculate() runs
    syncFromGlobal();
  </script>
</body>
</html>
